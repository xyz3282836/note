import{_ as n,W as s,X as a,a0 as t}from"./framework-52f8fb67.js";const e={},p=t(`<h1 id="grpc" tabindex="-1"><a class="header-anchor" href="#grpc" aria-hidden="true">#</a> GRPC</h1><h2 id="grpcå®˜æ–¹åº“" tabindex="-1"><a class="header-anchor" href="#grpcå®˜æ–¹åº“" aria-hidden="true">#</a> grpcå®˜æ–¹åº“</h2><p>å®šä¹‰äº†ä¸¤ä¸ªinterfaceï¼šResolverå’ŒBuilder</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Resolver watches for the updates on the specified target.</span>
<span class="token comment">// Updates include address updates and service config updates.</span>
<span class="token keyword">type</span> Resolver <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token comment">// ResolveNow will be called by gRPC to try to resolve the target name</span>
	<span class="token comment">// again. It&#39;s just a hint, resolver can ignore this if it&#39;s not necessary.</span>
	<span class="token comment">//</span>
	<span class="token comment">// It could be called multiple times concurrently.</span>
	<span class="token function">ResolveNow</span><span class="token punctuation">(</span>ResolveNowOptions<span class="token punctuation">)</span>
	<span class="token comment">// Close closes the resolver.</span>
	<span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Builder creates a resolver that will be used to watch name resolution updates.</span>
<span class="token keyword">type</span> Builder <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token comment">// Build creates a new resolver for the given target.</span>
	<span class="token comment">//</span>
	<span class="token comment">// gRPC dial calls Build synchronously, and fails if the returned error is</span>
	<span class="token comment">// not nil.</span>
	<span class="token function">Build</span><span class="token punctuation">(</span>target Target<span class="token punctuation">,</span> cc ClientConn<span class="token punctuation">,</span> opts BuildOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>Resolver<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token comment">// Scheme returns the scheme supported by this resolver.</span>
	<span class="token comment">// Scheme is defined at https://github.com/grpc/grpc/blob/master/doc/naming.md.</span>
	<span class="token function">Scheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="bç«™å®ç°" tabindex="-1"><a class="header-anchor" href="#bç«™å®ç°" aria-hidden="true">#</a> Bç«™å®ç°</h2><h3 id="wardenç›®å½•" tabindex="-1"><a class="header-anchor" href="#wardenç›®å½•" aria-hidden="true">#</a> wardenç›®å½•</h3><p>å®šä¹‰äº†warden.Resolverï¼Œwarden.Builderä¸¤ä¸ªç»“æ„ä½“</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// å®ç°äº†grpc.Resolveræ¥å£</span>
<span class="token keyword">type</span> Resolver <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  nr   naming<span class="token punctuation">.</span>Resolver <span class="token comment">// å®ç°æœ‰ name/discovery Resolverç»“æ„ï¼ŒåŒ…å«äº†Discoveryç»“æ„</span>
	cc   resolver<span class="token punctuation">.</span>ClientConn <span class="token comment">// grpcçš„interface</span>
	quit <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

	zone <span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment">// å®ç°äº†GRPC.Builder.Buildæ–¹æ³•</span>
<span class="token keyword">type</span> Builder <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	naming<span class="token punctuation">.</span>Builder <span class="token comment">// å®ç°æœ‰ name/discovery Discoveryç»“æ„</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>warden.Resolverå®ç°äº†<code>GRPC.Resolver</code>ï¼Œä¹ŸåŒ…å«name.Resolveræ¥å£ï¼Œè¿™é‡Œå¯ä»¥ä¼ é€’name.Resolverçš„å®ç°ï¼Œæ¯”å¦‚name/discoveryé‡ŒDiscoveryå¯¹è±¡</p><p>warden.Builderå®ç°äº†<code>GRPC.Builder.Build</code>ï¼Œå”¯ä¸€åŒ…å«naming.Builderæ¥å£ï¼Œè¿™é‡Œå¯ä»¥ä¼ é€’naming.Builderçš„å®ç°ï¼Œæ¯”å¦‚name/discoveryé‡ŒDiscoveryå¯¹è±¡</p><p>wardenä¸­NewClientä¼ é€’çš„å°±æ˜¯Discoveryå¯¹è±¡ï¼Œå¹¶ä¸”è°ƒç”¨äº†grpc.resolver.Registeræ³¨å†Œäº†Discoveryå¯¹è±¡ï¼›ç„¶ågrpcä¸­åœ¨DialContextä¼šæœ€ç»ˆè°ƒç”¨<code>Build(target Target, cc ClientConn, opts BuildOptions) (Resolver, error)</code>æ–¹æ³•ï¼ˆè°ƒç”¨é“¾è·¯è¯¦è§åé¢åˆ†æï¼‰ï¼Œå¦‚ä¸‹Buildæ–¹æ³•å®ç°ä¸­åˆ›å»ºwarden.Resolverå¯¹è±¡ï¼Œå…¶ä¸­warden.Resolver.nrå°±æ˜¯Discoveryå¯¹è±¡ï¼Œè°ƒç”¨<code>Build(appid string, opts ...naming.BuildOpt) naming.Resolver</code>åˆ›å»ºçš„name/discovery Resolverå¯¹è±¡ï¼ˆåŒ…å«äº†Discoveryå¯¹è±¡ï¼‰ï¼Œç„¶ååœ¨æ–¹æ³•ä¸­ä¼šæœ€ç»ˆè°ƒç”¨name/discovery Discoveryçš„pollså’ŒFetchæ–¹æ³•</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Build returns itself for Resolver, because it&#39;s both a builder and a resolver.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>Builder<span class="token punctuation">)</span> <span class="token function">Build</span><span class="token punctuation">(</span>target resolver<span class="token punctuation">.</span>Target<span class="token punctuation">,</span> cc resolver<span class="token punctuation">.</span>ClientConn<span class="token punctuation">,</span> opts resolver<span class="token punctuation">.</span>BuildOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>resolver<span class="token punctuation">.</span>Resolver<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> zone <span class="token operator">=</span> env<span class="token punctuation">.</span>Zone
	ss <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>
	clusters <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	str <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">SplitN</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>Endpoint<span class="token punctuation">,</span> <span class="token string">&quot;?&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;resolver: parse target.Endpoint(%s) failed!err:=endpoint is empty&quot;</span><span class="token punctuation">,</span> target<span class="token punctuation">.</span>Endpoint<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span> <span class="token punctuation">{</span>
		m<span class="token punctuation">,</span> err <span class="token operator">:=</span> url<span class="token punctuation">.</span><span class="token function">ParseQuery</span><span class="token punctuation">(</span>str<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> c <span class="token operator">:=</span> <span class="token keyword">range</span> m<span class="token punctuation">[</span>naming<span class="token punctuation">.</span>MetaCluster<span class="token punctuation">]</span> <span class="token punctuation">{</span>
				clusters<span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			zones <span class="token operator">:=</span> m<span class="token punctuation">[</span>naming<span class="token punctuation">.</span>MetaZone<span class="token punctuation">]</span>
			<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>zones<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				zone <span class="token operator">=</span> zones<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> sub<span class="token punctuation">,</span> ok <span class="token operator">:=</span> m<span class="token punctuation">[</span><span class="token string">&quot;subset&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
				<span class="token keyword">if</span> t<span class="token punctuation">,</span> err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseInt</span><span class="token punctuation">(</span>sub<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					ss <span class="token operator">=</span> t
				<span class="token punctuation">}</span>

			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	r <span class="token operator">:=</span> <span class="token operator">&amp;</span>Resolver<span class="token punctuation">{</span>
		nr<span class="token punctuation">:</span>   b<span class="token punctuation">.</span>Builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span>str<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> naming<span class="token punctuation">.</span><span class="token function">Filter</span><span class="token punctuation">(</span>Scheme<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">,</span> naming<span class="token punctuation">.</span><span class="token function">ScheduleNode</span><span class="token punctuation">(</span>zone<span class="token punctuation">)</span><span class="token punctuation">,</span> naming<span class="token punctuation">.</span><span class="token function">Subset</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>ss<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		cc<span class="token punctuation">:</span>   cc<span class="token punctuation">,</span>
		quit<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		zone<span class="token punctuation">:</span> zone<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">go</span> r<span class="token punctuation">.</span><span class="token function">updateproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> r<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// è¿™é‡Œçš„ b.Builder.Build =&gt; Discovery.serverproc =&gt; Discovery.poll =&gt; http è¯·æ±‚ http://%s/discovery/polls grpcæœåŠ¡å®ä¾‹èŠ‚ç‚¹ä¿¡æ¯</span>

<span class="token comment">// è¿™é‡Œçš„ r.updateproc =&gt; </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ•´ä¸ªé“¾è·¯ï¼š</p><p>client ç«¯</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>	<span class="token comment">// å®¢æˆ·ç«¯ new ç›®æ ‡grpcæœåŠ¡çš„client</span>
	<span class="token keyword">if</span> cfg <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		cfg <span class="token operator">=</span> <span class="token operator">&amp;</span>warden<span class="token punctuation">.</span>ClientConfig<span class="token punctuation">{</span>NonBlock<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		cfg<span class="token punctuation">.</span>NonBlock <span class="token operator">=</span> <span class="token boolean">true</span>
	<span class="token punctuation">}</span>
	client <span class="token operator">:=</span> warden<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span>
	conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;discovery://default/&quot;</span><span class="token operator">+</span><span class="token string">&quot;live.live.online-allliving&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	cli <span class="token operator">=</span> <span class="token operator">&amp;</span>Client<span class="token punctuation">{</span>
		AllLivingClient<span class="token punctuation">:</span> v1<span class="token punctuation">.</span><span class="token function">NewAllLivingClient</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">,</span>
		MaxIdClient<span class="token punctuation">:</span> v1<span class="token punctuation">.</span><span class="token function">NewMaxIdClient</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸¤ç‚¹ï¼Œç¬¬ä¸€</p><p>å¾€grpcæ³¨å†Œdiscoveryå®ç°å®ä¾‹</p><p>warden.NewClient =&gt; warden.resolver.Register(discovery.Builder()) =&gt; grpc.resolver.Register(name/discovery Discovery) =&gt; grpc.resolver.m[discovery.Scheme()]=name/discovery Discovery</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>client <span class="token operator">:=</span> warden<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token comment">// è¿™é‡Œ warden.NewClientè°ƒç”¨</span>

<span class="token keyword">func</span> <span class="token function">NewClient</span><span class="token punctuation">(</span>conf <span class="token operator">*</span>ClientConfig<span class="token punctuation">,</span> opt <span class="token operator">...</span>grpc<span class="token punctuation">.</span>DialOption<span class="token punctuation">)</span> <span class="token operator">*</span>Client <span class="token punctuation">{</span>
  <span class="token comment">// è¿™é‡Œå°±æ˜¯new name.discovery çš„å®ç°</span>
	resolver<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>discovery<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	c <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>Client<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">SetConfig</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>abtest<span class="token punctuation">.</span><span class="token function">UnaryClientInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// TODO(luhao02): move to component</span>
	c<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>auroragrpc<span class="token punctuation">.</span><span class="token function">UnaryClientInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	c<span class="token punctuation">.</span><span class="token function">UseOpt</span><span class="token punctuation">(</span>grpc<span class="token punctuation">.</span><span class="token function">WithDefaultServiceConfig</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">\`{&quot;loadBalancingPolicy&quot;:&quot;%s&quot;}\`</span><span class="token punctuation">,</span> p2c<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	c<span class="token punctuation">.</span><span class="token function">UseOpt</span><span class="token punctuation">(</span>opt<span class="token operator">...</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> c
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç¬¬äºŒ</p><p>targetæ ¼å¼</p><p>client.Dial =&gt; warden.Dial =&gt; warden.dial =&gt; grpc.DialContext =&gt; grpc.newCCResolverWrapper æ­¤å¤„ä¼šæ‹¿åˆ° resolverBuilderï¼Œå°±æ˜¯ä»ä¸Šä¸€æ­¥grpc.resolver.mé€šè¿‡grpc.ClientConn.targetï¼Œæ ¼å¼ä¸º[scheme]ğŸ˜•/[authority]/endpointï¼Œè§£æå‡ºschemeä¸º&quot;discovery&quot; =&gt; grpc.resolver.Builder.Build =&gt; name/discovery Discovery.Build =&gt; name/discovery Discovery.serverproc(=&gt;name/discovery Discovery.polls) &amp;&amp; åˆ›å»ºäº†name/discovery Resolverå¯¹è±¡(=&gt;name/discovery Resolver.updateproc =&gt; name/discovery Resolver.nrä¹Ÿå°±æ˜¯name/discovery Discovery.Fetch)</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;discovery://default/&quot;</span><span class="token operator">+</span><span class="token string">&quot;live.live.online-allliving&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// è¿™é‡Œ client.Dial è°ƒç”¨</span>

<span class="token comment">// Dial creates a client connection to the given target.</span>
<span class="token comment">// Target format is scheme://authority/endpoint?query_arg=value</span>
<span class="token comment">// example: discovery://default/account.account.service?cluster=shfy01&amp;cluster=shfy02</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">Dial</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> target <span class="token builtin">string</span><span class="token punctuation">,</span> opts <span class="token operator">...</span>grpc<span class="token punctuation">.</span>DialOption<span class="token punctuation">)</span> <span class="token punctuation">(</span>conn <span class="token operator">*</span>grpc<span class="token punctuation">.</span>ClientConn<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	opts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> grpc<span class="token punctuation">.</span><span class="token function">WithInsecure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">dial</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> target<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// è¿™é‡Œ c.dial è°ƒç”¨</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">dial</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> target <span class="token builtin">string</span><span class="token punctuation">,</span> opts <span class="token operator">...</span>grpc<span class="token punctuation">.</span>DialOption<span class="token punctuation">)</span> <span class="token punctuation">(</span>conn <span class="token operator">*</span>grpc<span class="token punctuation">.</span>ClientConn<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 	<span class="token operator">...</span>
  <span class="token keyword">if</span> conn<span class="token punctuation">,</span> err <span class="token operator">=</span> grpc<span class="token punctuation">.</span><span class="token function">DialContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> target<span class="token punctuation">,</span> dialOptions<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> <span class="token string">&quot;warden client: dial %s error %v!&quot;</span><span class="token punctuation">,</span> target<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
<span class="token comment">// è¿™é‡Œ grpc.DialContext è°ƒç”¨äº†grpc å®˜æ–¹åº“</span>

<span class="token keyword">func</span> <span class="token function">DialContext</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> target <span class="token builtin">string</span><span class="token punctuation">,</span> opts <span class="token operator">...</span>DialOption<span class="token punctuation">)</span> <span class="token punctuation">(</span>conn <span class="token operator">*</span>ClientConn<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
  <span class="token comment">// Build the resolver.</span>
	rWrapper<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">newCCResolverWrapper</span><span class="token punctuation">(</span>cc<span class="token punctuation">,</span> resolverBuilder<span class="token punctuation">)</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
<span class="token comment">// è¿™é‡Œ newCCResolverWrapper è°ƒç”¨</span>

<span class="token keyword">func</span> <span class="token function">newCCResolverWrapper</span><span class="token punctuation">(</span>cc <span class="token operator">*</span>ClientConn<span class="token punctuation">,</span> rb resolver<span class="token punctuation">.</span>Builder<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>ccResolverWrapper<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
  ccr<span class="token punctuation">.</span>resolver<span class="token punctuation">,</span> err <span class="token operator">=</span> rb<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span>cc<span class="token punctuation">.</span>parsedTarget<span class="token punctuation">,</span> ccr<span class="token punctuation">,</span> rbo<span class="token punctuation">)</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="naming" tabindex="-1"><a class="header-anchor" href="#naming" aria-hidden="true">#</a> naming</h3><p>å®šä¹‰äº†ä¸‰ä¸ªæ¥å£</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Resolver resolve naming service</span>
<span class="token keyword">type</span> Resolver <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Fetch</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Instance<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span>
	<span class="token comment">//Unwatch(id string)</span>
	<span class="token function">Watch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">}</span>

<span class="token comment">// Registry Register an instance and renew automatically</span>
<span class="token keyword">type</span> Registry <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Register</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> <span class="token operator">*</span>Instance<span class="token punctuation">)</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>CancelFunc<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">}</span>

<span class="token comment">// Builder resolver builder.</span>
<span class="token keyword">type</span> Builder <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Build</span><span class="token punctuation">(</span>id <span class="token builtin">string</span><span class="token punctuation">,</span> options <span class="token operator">...</span>BuildOpt<span class="token punctuation">)</span> Resolver
	<span class="token function">Scheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>name.Discovery å®ç°äº† name.Registry å’Œ name.Builder</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Discovery is discovery client.</span>
<span class="token keyword">type</span> Discovery <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	once       sync<span class="token punctuation">.</span>Once
	conf       <span class="token operator">*</span>Config
	ctx        context<span class="token punctuation">.</span>Context
	cancelFunc context<span class="token punctuation">.</span>CancelFunc
	httpClient <span class="token operator">*</span>bm<span class="token punctuation">.</span>Client

	mutex       sync<span class="token punctuation">.</span>RWMutex
	apps        <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>appInfo
	registry    <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	lastHost    <span class="token builtin">string</span>
	cancelPolls context<span class="token punctuation">.</span>CancelFunc
	idx         <span class="token builtin">uint64</span>
	node        atomic<span class="token punctuation">.</span>Value
	<span class="token builtin">delete</span>      <span class="token keyword">chan</span> <span class="token operator">*</span>appInfo
	<span class="token builtin">close</span>       <span class="token builtin">int64</span>
<span class="token punctuation">}</span>

<span class="token comment">// Resolver discveory resolver.</span>
<span class="token keyword">type</span> Resolver <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	id    <span class="token builtin">string</span>
	event <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
	d     <span class="token operator">*</span>Discovery
	opt   <span class="token operator">*</span>naming<span class="token punctuation">.</span>BuildOptions
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>name.Discovery.Resolver å®ç°äº† name.Resolver</p><p>æ‰€ä»¥ name.Discovery è°ƒç”¨Build æ–¹æ³•å¯ä»¥åˆ›å»ºname.Discovery.Resolver</p>`,30),o=[p];function c(i,l){return s(),a("div",null,o)}const r=n(e,[["render",c],["__file","grpc.html.vue"]]);export{r as default};
