import{_ as n}from"./plugin-vue_export-helper-c27b6911.js";import{o as s,c as a,a as t}from"./app-6f5bc1f7.js";const p={},o=t(`<h1 id="mc" tabindex="-1"><a class="header-anchor" href="#mc" aria-hidden="true">#</a> mc</h1><p>Memcache 主体结构，其中有 Pool 结构，相当于包了一层，主张使用主体结构。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Memcache <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	pool <span class="token operator">*</span>Pool
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Pool 结构中有 pool.Pool，其实是连接池的 interface，mc 中使用 pool.NewList 来实现，也就是链表的实现，同时还有个 slice 的实现。</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Pool <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	p pool<span class="token punctuation">.</span>Pool <span class="token comment">// 连接池的接口，实际mc使用list来实现</span>
	c <span class="token operator">*</span>Config
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">NewPool</span><span class="token punctuation">(</span>cfg <span class="token operator">*</span>Config<span class="token punctuation">)</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Pool<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> cfg<span class="token punctuation">.</span>DialTimeout <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> cfg<span class="token punctuation">.</span>ReadTimeout <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> cfg<span class="token punctuation">.</span>WriteTimeout <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;must config memcache timeout&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	p1 <span class="token operator">:=</span> pool<span class="token punctuation">.</span><span class="token function">NewList</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>Config<span class="token punctuation">)</span>
	cnop <span class="token operator">:=</span> <span class="token function">DialConnectTimeout</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>DialTimeout<span class="token punctuation">)</span><span class="token punctuation">)</span>
	rdop <span class="token operator">:=</span> <span class="token function">DialReadTimeout</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>ReadTimeout<span class="token punctuation">)</span><span class="token punctuation">)</span>
	wrop <span class="token operator">:=</span> <span class="token function">DialWriteTimeout</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>WriteTimeout<span class="token punctuation">)</span><span class="token punctuation">)</span>
	p1<span class="token punctuation">.</span>New <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">(</span>io<span class="token punctuation">.</span>Closer<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">Dial</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>Proto<span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>Addr<span class="token punctuation">,</span> cnop<span class="token punctuation">,</span> rdop<span class="token punctuation">,</span> wrop<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token function">newTraceConn</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%s://%s&quot;</span><span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>Proto<span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>Addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	p <span class="token operator">=</span> <span class="token operator">&amp;</span>Pool<span class="token punctuation">{</span>p<span class="token punctuation">:</span> p1<span class="token punctuation">,</span> c<span class="token punctuation">:</span> cfg<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>NewPool 中，pool.Pool 由 pool.NewList 实现，也就是 pool 中 list 实现，list 中的 New 是个生成连接的方法，New 由 newTraceConn 实现，第一个参数是 Conn 接口的实现，由 Dial 实现</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Dial connects to the Memcache server at the given network and</span>
<span class="token comment">// address using the specified options.</span>
<span class="token keyword">func</span> <span class="token function">Dial</span><span class="token punctuation">(</span>network<span class="token punctuation">,</span> address <span class="token builtin">string</span><span class="token punctuation">,</span> options <span class="token operator">...</span>DialOption<span class="token punctuation">)</span> <span class="token punctuation">(</span>Conn<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	do <span class="token operator">:=</span> dialOptions<span class="token punctuation">{</span>
		dial<span class="token punctuation">:</span> net<span class="token punctuation">.</span>Dial<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> option <span class="token operator">:=</span> <span class="token keyword">range</span> options <span class="token punctuation">{</span>
		option<span class="token punctuation">.</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>do<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	netConn<span class="token punctuation">,</span> err <span class="token operator">:=</span> do<span class="token punctuation">.</span><span class="token function">dial</span><span class="token punctuation">(</span>network<span class="token punctuation">,</span> address<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> pkgerr<span class="token punctuation">.</span><span class="token function">WithStack</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	pconn<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">newASCIIConn</span><span class="token punctuation">(</span>netConn<span class="token punctuation">,</span> do<span class="token punctuation">.</span>readTimeout<span class="token punctuation">,</span> do<span class="token punctuation">.</span>writeTimeout<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>conn<span class="token punctuation">{</span>pconn<span class="token punctuation">:</span> pconn<span class="token punctuation">,</span> ed<span class="token punctuation">:</span> <span class="token function">newEncodeDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token comment">// 实现了Conn接口</span>
<span class="token keyword">type</span> conn <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// low level connection.</span>
	pconn protocolConn<span class="token comment">// 由newASCIIConn方法返回的asiiConn的结构实现</span>
	ed    <span class="token operator">*</span>encodeDecode
<span class="token punctuation">}</span>

<span class="token comment">// low level connection that implement memcache protocol provide basic operation.</span>
<span class="token keyword">type</span> protocolConn <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Populate</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> cmd <span class="token builtin">string</span><span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">,</span> flags <span class="token builtin">uint32</span><span class="token punctuation">,</span> expiration <span class="token builtin">int32</span><span class="token punctuation">,</span> cas <span class="token builtin">uint64</span><span class="token punctuation">,</span> data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
	<span class="token function">Get</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Item<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token function">GetMulti</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> keys <span class="token operator">...</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>Item<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token function">Touch</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">,</span> expire <span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
	<span class="token function">IncrDecr</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">,</span> delta <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">uint64</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>
	<span class="token function">Delete</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> key <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
	<span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
	<span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Dial 返回 conn 结构</strong>，其中 conn 结构中的 protocolConn 是个 interface，需要实现，由 newASCIIConn 方法实现，其中第一个参数是 net.Conn，由 net.Dial(go sdk)方法返回；newASCIIConn 方法返回的 asiiConn 实现了 protocolConn 接口；而 conn 结构实现了 Conn 接口</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// newConn returns a new memcache connection for the given net connection.</span>
<span class="token keyword">func</span> <span class="token function">newASCIIConn</span><span class="token punctuation">(</span>netConn net<span class="token punctuation">.</span>Conn<span class="token punctuation">,</span> readTimeout<span class="token punctuation">,</span> writeTimeout time<span class="token punctuation">.</span>Duration<span class="token punctuation">)</span> <span class="token punctuation">(</span>protocolConn<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> writeTimeout <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> readTimeout <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> pkgerr<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;readTimeout writeTimeout can&#39;t be zero&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	c <span class="token operator">:=</span> <span class="token operator">&amp;</span>asiiConn<span class="token punctuation">{</span>
		conn<span class="token punctuation">:</span> netConn<span class="token punctuation">,</span>
		rw<span class="token punctuation">:</span> bufio<span class="token punctuation">.</span><span class="token function">NewReadWriter</span><span class="token punctuation">(</span>bufio<span class="token punctuation">.</span><span class="token function">NewReader</span><span class="token punctuation">(</span>netConn<span class="token punctuation">)</span><span class="token punctuation">,</span>
			bufio<span class="token punctuation">.</span><span class="token function">NewWriter</span><span class="token punctuation">(</span>netConn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		readTimeout<span class="token punctuation">:</span>  readTimeout<span class="token punctuation">,</span>
		writeTimeout<span class="token punctuation">:</span> writeTimeout<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> c<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> <span class="token boolean">_</span> protocolConn <span class="token operator">=</span> <span class="token operator">&amp;</span>asiiConn<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token comment">// asiiConn is the low-level implementation of Conn</span>
<span class="token keyword">type</span> asiiConn <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	err  <span class="token builtin">error</span>
	conn net<span class="token punctuation">.</span>Conn
	<span class="token comment">// Read &amp; Write</span>
	readTimeout  time<span class="token punctuation">.</span>Duration
	writeTimeout time<span class="token punctuation">.</span>Duration
	rw           <span class="token operator">*</span>bufio<span class="token punctuation">.</span>ReadWriter
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>回到 NewPool 方法，其中 New 由 newTraceConn 实现，第一个参数由 Dial 方法返回了 Conn 的实现</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">newTraceConn</span><span class="token punctuation">(</span>conn Conn<span class="token punctuation">,</span> address <span class="token builtin">string</span><span class="token punctuation">)</span> Conn <span class="token punctuation">{</span>
	tags <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>trace<span class="token punctuation">.</span>Tag<span class="token punctuation">{</span>
		trace<span class="token punctuation">.</span>SpanKindClientTag<span class="token punctuation">,</span>
		trace<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>trace<span class="token punctuation">.</span>TagComponent<span class="token punctuation">,</span> <span class="token string">&quot;cache/memcache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		trace<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>trace<span class="token punctuation">.</span>TagPeerService<span class="token punctuation">,</span> <span class="token string">&quot;memcache&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		trace<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span>trace<span class="token punctuation">.</span>TagPeerAddress<span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>traceConn<span class="token punctuation">{</span>Conn<span class="token punctuation">:</span> conn<span class="token punctuation">,</span> tags<span class="token punctuation">:</span> tags<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">type</span> traceConn <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Conn
	tags <span class="token punctuation">[</span><span class="token punctuation">]</span>trace<span class="token punctuation">.</span>Tag
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>traceConn 中的 Conn 实际是 Dial 的返回 Conn 的实现</p>`,12),e=[o];function c(i,u){return s(),a("div",null,e)}const r=n(p,[["render",c],["__file","mc.html.vue"]]);export{r as default};
