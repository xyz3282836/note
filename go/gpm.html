<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.63" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://www.ruizhou.cf/go/gpm.html"><meta property="og:site_name" content="rzæ–‡æ¡£"><meta property="og:title" content="gmp"><meta property="og:description" content="Go ç¨‹åºæ‰§è¡Œè¿‡ å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆgo ç¼–è¯‘å¥½çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼‰å¼€å§‹æ‰§è¡Œ _rt0_amd64_windows // ä¸åŒå¹³å°æ‰§è¡Œå…¥å£ä¸åŒ _rt0_amd64_linux // ä¸åŒå¹³å°æ‰§è¡Œå…¥å£ä¸åŒ ...osinit... // ä¸€ç³»åˆ—çš„æ£€æµ‹å’Œåˆå§‹åŒ– schedinit è°ƒåº¦åˆå§‹åŒ–ï¼ŒæŒ‰ç…§ GOMAXPROCS è¿™ä¸ªç¯å¢ƒå˜é‡å†³å®šåˆ›å»ºå¤šå°‘ä¸ª pï¼Œallp çš„æ•°é‡ åˆ›å»º main goroutine ä¹‹å‰ allp[0]-&gt;m0-&gt;g0 ä»¥ runtime.run ä¸ºç¨‹åºå…¥å£ï¼Œnew main goroutine(newproc å‡½æ•°è°ƒç”¨)"><meta property="og:type" content="article"><meta property="og:image" content="https://www.ruizhou.cf/"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-03-22T14:48:45.000Z"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image:alt" content="gmp"><meta property="article:author" content="rz"><meta property="article:modified_time" content="2023-03-22T14:48:45.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"gmp","image":["https://www.ruizhou.cf/"],"dateModified":"2023-03-22T14:48:45.000Z","author":[{"@type":"Person","name":"rz","url":"https://github.com/xyz3282836/monodoc"}]}</script><title>gmp | rzæ–‡æ¡£</title><meta name="description" content="Go ç¨‹åºæ‰§è¡Œè¿‡ å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆgo ç¼–è¯‘å¥½çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼‰å¼€å§‹æ‰§è¡Œ _rt0_amd64_windows // ä¸åŒå¹³å°æ‰§è¡Œå…¥å£ä¸åŒ _rt0_amd64_linux // ä¸åŒå¹³å°æ‰§è¡Œå…¥å£ä¸åŒ ...osinit... // ä¸€ç³»åˆ—çš„æ£€æµ‹å’Œåˆå§‹åŒ– schedinit è°ƒåº¦åˆå§‹åŒ–ï¼ŒæŒ‰ç…§ GOMAXPROCS è¿™ä¸ªç¯å¢ƒå˜é‡å†³å®šåˆ›å»ºå¤šå°‘ä¸ª pï¼Œallp çš„æ•°é‡ åˆ›å»º main goroutine ä¹‹å‰ allp[0]-&gt;m0-&gt;g0 ä»¥ runtime.run ä¸ºç¨‹åºå…¥å£ï¼Œnew main goroutine(newproc å‡½æ•°è°ƒç”¨)">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-152f4349.css" as="style"><link rel="stylesheet" href="/assets/style-152f4349.css">
    <link rel="modulepreload" href="/assets/app-08e26ff4.js"><link rel="modulepreload" href="/assets/gpm.html-7fb8baec.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-c27b6911.js"><link rel="modulepreload" href="/assets/gpm.html-48668f73.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="md-link vp-brand" href="/"><img class="vp-nav-logo" src="/hero.png" alt="rzæ–‡æ¡£"><!----><span class="vp-site-name hide-in-pad">rzæ–‡æ¡£</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a class="md-link nav-link" href="/"><span class="font-icon icon iconfont icon-home" style=""></span>rzçš„æ–‡æ¡£<!----></a></div><div class="nav-item hide-in-mobile"><a class="md-link nav-link active" href="/go/"><!---->Go<!----></a></div><div class="nav-item hide-in-mobile"><a class="md-link nav-link" href="/linux/"><!---->Liunx<!----></a></div><div class="nav-item hide-in-mobile"><a class="md-link nav-link" href="/apue/"><!---->Unixç¯å¢ƒé«˜çº§ç¼–ç¨‹<!----></a></div><div class="nav-item hide-in-mobile"><a class="md-link nav-link" href="/source-code/"><!---->æºç è§£è¯»<!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/xyz3282836/monodoc" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" class="outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><!----><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Asm</span><span class="vp-arrow end"></span></button><!----></section></li><li><!--[--><a class="md-link nav-link vp-sidebar-link vp-sidebar-page" href="/go/buf.html"><!---->buf<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="md-link nav-link vp-sidebar-link vp-sidebar-page" href="/go/gc.html"><!---->gc<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="md-link nav-link vp-sidebar-link vp-sidebar-page" href="/go/gc%20%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html"><!---->gc æ€§èƒ½ä¼˜åŒ–<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="md-link nav-link active vp-sidebar-link vp-sidebar-page active" href="/go/gpm.html"><!---->gmp<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="md-link nav-link vp-sidebar-link vp-heading" href="/go/gpm.html#æ–°.html"><!---->æ–°<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="md-link nav-link vp-sidebar-link vp-heading" href="/go/gpm.html#çº¿ç¨‹.html"><!---->çº¿ç¨‹<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="md-link nav-link vp-sidebar-link vp-heading" href="/go/gpm.html#ä¼ ç»Ÿåç¨‹.html"><!---->ä¼ ç»Ÿåç¨‹<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="md-link nav-link vp-sidebar-link vp-heading" href="/go/gpm.html#goroutine.html"><!---->goroutine<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="md-link nav-link vp-sidebar-link vp-heading" href="/go/gpm.html#å¯¹æ¯”.html"><!---->å¯¹æ¯”<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="md-link nav-link vp-sidebar-link vp-heading" href="/go/gpm.html#gmp.html"><!---->GMP<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="md-link nav-link vp-sidebar-link vp-heading" href="/go/gpm.html#g.html"><!---->g<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="md-link nav-link vp-sidebar-link vp-heading" href="/go/gpm.html#m.html"><!---->m<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="md-link nav-link vp-sidebar-link vp-heading" href="/go/gpm.html#p.html"><!---->p<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="md-link nav-link vp-sidebar-link vp-heading" href="/go/gpm.html#å…¨å±€é˜Ÿåˆ—.html"><!---->å…¨å±€é˜Ÿåˆ—<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="md-link nav-link vp-sidebar-link vp-heading" href="/go/gpm.html#è°ƒåº¦.html"><!---->è°ƒåº¦<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="md-link nav-link vp-sidebar-link vp-heading" href="/go/gpm.html#è°ƒåº¦ç±»å‹.html"><!---->è°ƒåº¦ç±»å‹<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="md-link nav-link vp-sidebar-link vp-heading" href="/go/gpm.html#è°ƒåº¦æµç¨‹.html"><!---->è°ƒåº¦æµç¨‹<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="md-link nav-link vp-sidebar-link vp-heading" href="/go/gpm.html#reference.html"><!---->reference<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a class="md-link nav-link vp-sidebar-link vp-sidebar-page" href="/go/go%20tool%20compile.html"><!---->go tool compile<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="md-link nav-link vp-sidebar-link vp-sidebar-page" href="/go/grpc.html"><!---->grpc<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="md-link nav-link vp-sidebar-link vp-sidebar-page" href="/go/mod.html"><!---->mod<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Profiles</span><span class="vp-arrow end"></span></button><!----></section></li><li><!--[--><a class="md-link nav-link vp-sidebar-link vp-sidebar-page" href="/go/protoc.html"><!---->protoc<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="md-link nav-link vp-sidebar-link vp-sidebar-page" href="/go/test.html"><!---->test<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="md-link nav-link vp-sidebar-link vp-sidebar-page" href="/go/%E5%9F%BA%E7%A1%80.html"><!---->åŸºç¡€<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="md-link nav-link vp-sidebar-link vp-sidebar-page" href="/go/%E6%A6%82%E5%BF%B5.html"><!---->åŸºç¡€æ¦‚å¿µ<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="md-link nav-link vp-sidebar-link vp-sidebar-page" href="/go/%E6%9D%82%E9%A1%B9.html"><!---->æ‚é¡¹<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="md-link nav-link vp-sidebar-link vp-sidebar-page" href="/go/%E6%AF%9B%E5%89%91.html"><!---->æ¯›è€å¸ˆè¯­å½•<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="md-link nav-link vp-sidebar-link vp-sidebar-page" href="/go/%E7%89%88%E6%9C%AC%E5%8D%87%E7%BA%A7.html"><!---->ç‰ˆæœ¬å‡çº§<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="md-link nav-link vp-sidebar-link vp-sidebar-page" href="/go/%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4.html"><!---->ç›¸å…³å‘½ä»¤<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="md-link nav-link vp-sidebar-link vp-sidebar-page" href="/go/%E8%B0%83%E5%BA%A6.html"><!---->è°ƒåº¦<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="md-link nav-link vp-sidebar-link vp-sidebar-page" href="/go/%E9%97%AD%E5%8C%85.html"><!---->é—­åŒ…<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->gmp</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://github.com/xyz3282836/monodoc" target="_blank" rel="noopener noreferrer">rz</a></span><span property="author" content="rz"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-03-11T14:36:50.000Z"></span><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 23 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT23M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="md-link toc-link level2" href="/#æ–°.html">æ–°</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="md-link toc-link level2" href="/#çº¿ç¨‹.html">çº¿ç¨‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="md-link toc-link level2" href="/#ä¼ ç»Ÿåç¨‹.html">ä¼ ç»Ÿåç¨‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="md-link toc-link level2" href="/#goroutine.html">goroutine</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="md-link toc-link level2" href="/#å¯¹æ¯”.html">å¯¹æ¯”</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="md-link toc-link level2" href="/#gmp.html">GMP</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="md-link toc-link level3" href="/#g.html">g</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="md-link toc-link level3" href="/#m.html">m</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="md-link toc-link level3" href="/#p.html">p</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="md-link toc-link level3" href="/#å…¨å±€é˜Ÿåˆ—.html">å…¨å±€é˜Ÿåˆ—</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="md-link toc-link level2" href="/#è°ƒåº¦.html">è°ƒåº¦</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="md-link toc-link level3" href="/#è°ƒåº¦ç±»å‹.html">è°ƒåº¦ç±»å‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="md-link toc-link level3" href="/#è°ƒåº¦æµç¨‹.html">è°ƒåº¦æµç¨‹</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="md-link toc-link level2" href="/#reference.html">reference</a></li><!----><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><p>Go ç¨‹åºæ‰§è¡Œè¿‡</p><p>å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆgo ç¼–è¯‘å¥½çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼‰å¼€å§‹æ‰§è¡Œ</p><p>_rt0_amd64_windows // ä¸åŒå¹³å°æ‰§è¡Œå…¥å£ä¸åŒ</p><p>_rt0_amd64_linux // ä¸åŒå¹³å°æ‰§è¡Œå…¥å£ä¸åŒ</p><p>...osinit... // ä¸€ç³»åˆ—çš„æ£€æµ‹å’Œåˆå§‹åŒ–</p><p>schedinit è°ƒåº¦åˆå§‹åŒ–ï¼ŒæŒ‰ç…§ GOMAXPROCS è¿™ä¸ªç¯å¢ƒå˜é‡å†³å®šåˆ›å»ºå¤šå°‘ä¸ª pï¼Œallp çš„æ•°é‡</p><p>åˆ›å»º main goroutine ä¹‹å‰ allp[0]-&gt;m0-&gt;g0</p><p>ä»¥ runtime.run ä¸ºç¨‹åºå…¥å£ï¼Œnew main goroutine(newproc å‡½æ•°è°ƒç”¨)</p><p>åˆ›å»º main goroutine ä¹‹åï¼Œmain goroutine ä¼šåŠ å…¥åˆ°å½“å‰ p ä¹Ÿå°±æ˜¯ allp[0]çš„æœ¬åœ° runq ä¸­</p><p>mstart(--&gt;schedule()) å‡½æ•°å¼€å¯å¾ªç¯è°ƒåº¦ï¼Œæ˜¯æ‰€æœ‰å·¥ä½œçº¿ç¨‹çš„å…¥å£ï¼Œä¸»è¦æ˜¯è°ƒç”¨ schedule å‡½æ•°ï¼Œæ‰§è¡Œè°ƒåº¦å¾ªç¯</p><p>m0 å¼€å§‹æ‰§è¡Œå…³è” p ä¸­çš„ main goroutineï¼Œgoroutine ä¸­æ‰§è¡Œ runtime.main</p><p>runtime.main ä¸­ä¼šåˆ›å»º sysmonï¼Œpackage init ...</p><p>call main.main</p><p>...</p><p>ä»£ç ä¸­ä½¿ç”¨ go æ¥åˆ›å»ºåç¨‹ï¼Œä¼šè¢«ç¼–è¯‘å™¨è½¬æ¢ä¸º newproc å‡½æ•°è°ƒç”¨ï¼Œnewproc ä¼šç»™ goroutine æ„é€ ä¸€ä¸ªæ ˆå¸§ï¼Œç›®çš„è®©å…¶åç¨‹è¿è¡Œå®Œæ¯•åå¯ä»¥è¿”å› goexit()å‡½æ•°ä¸­ï¼Œè¿›è¡Œåç¨‹èµ„æºå¤„ç†çš„å·¥ä½œ</p><p>exit runtime.main ä¼šè°ƒç”¨ exit å‡½æ•°ç»“æŸè¿›ç¨‹</p><p>å‡ ä¸ªé‡è¦æ•°æ®ç»“æ„</p><p>runtime.g åç¨‹ç»“æ„</p><p>runtime.m å·¥ä½œçº¿ç¨‹ç»“æ„</p><p>runtime.p è°ƒåº¦ç»“æ„ runq</p><p>runtime.schedt è°ƒåº¦å™¨ç»“æ„ï¼Œè°ƒåº¦ç›¸å…³ä¿¡æ¯ç»“æ„ midleï¼Œpidleï¼Œrunq</p><p>å…¨å±€å˜é‡ g0 æ˜¯ä¸»çº¿ç¨‹å¯¹åº”çš„ gï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„ main goroutineï¼Œå¹¶ä¸”<strong>åœ¨ä¸»çº¿ç¨‹æ ˆä¸Šåˆ†é…</strong>ï¼Œç©ºé—´å¤§ï¼Œg0 æŒæœ‰ m0 çš„æŒ‡é’ˆ</p><p>å…¨å±€å˜é‡ m0 æ˜¯ä¸»çº¿ç¨‹å¯¹åº”çš„ mï¼Œm0 æŒæœ‰ g0 çš„æŒ‡é’ˆï¼Œå¹¶ä¸”æœ€å¼€å§‹ m0 æ‰§è¡Œçš„åç¨‹å°±æ˜¯ g0</p><p>æ²¡æœ‰å…¨å±€å˜é‡ p0</p><p>å…¨å±€å˜é‡ allgs è®°å½•æ‰€æœ‰ g</p><p>å…¨å±€å˜é‡ allm è®°å½•æ‰€æœ‰ m</p><p>å…¨å±€å˜é‡ allp è®°å½•æ‰€æœ‰ p</p><p>å…¨å±€å˜é‡ sched è®°å½•æ‰€æœ‰ç©ºé—²çš„ mï¼Œç©ºé—²çš„ p</p><p>æœ€ç»ˆ go çš„è°ƒåº¦æ¨¡å‹åªæœ‰ gmï¼Œå¯¼è‡´å„ä¸ª m äº‰æŠ¢ gï¼ŒåŠ äº†é”ï¼Œæ€§èƒ½å¾ˆå·®</p><p>åé¢å¼•å…¥äº† runtime.p æœ‰ä¸ªæœ¬åœ° runq [256]guintptrï¼Œè¿™æ ·åªè¦æŠŠä¸€ä¸ª p å…³è”åˆ°ä¸€ä¸ª mï¼Œm å°±å¯ä»¥ä» p è¿™é‡Œç›´æ¥è·å– gï¼Œp æœ‰ä¸ªæœ¬åœ° runqï¼Œä½†æ˜¯è¿˜æ˜¯å­˜åœ¨ä¸€ä¸ªå…¨å±€ runqï¼Œä¿å­˜åœ¨å…¨å±€å˜é‡ sched ä¸­</p><p>å¦‚æœ p çš„æœ¬åœ° runq æ»¡äº†ï¼Œå°±ä¼šæ”¾åˆ°å…¨å±€ sched çš„ runq ä¸­ï¼Œè€Œ m å…ˆä»è‡ªå·± p çš„æœ¬åœ° runq è·å– gï¼Œéƒ½å¤„ç†å®Œäº†å°±ä»å…¨å±€ runq ä¸­è·å– g æ¥æ‰§è¡Œï¼Œå¦‚æœå…¨å±€ runq ä¹Ÿæ²¡äº†é‚£å°±ä»åˆ«çš„ p çš„æœ¬åœ° runq è·å– g</p><p>allp[0] ä¹Ÿå°±æ˜¯ allp çš„ç¬¬ä¸€ä¸ª p äº m0 å…³è”èµ·æ¥</p><p>time.Sleep ä¼šè°ƒç”¨ gopark å‡½æ•°ï¼ŒæŠŠå½“å‰åç¨‹çŠ¶æ€ä»_Grunning æ”¹ä¸º _Gwaitingï¼Œä¸ä¼šæŠŠå½“å‰åç¨‹ g è¿”å›åˆ°æœ¬åœ° runq ä¸­ï¼Œè€Œæ˜¯åœ¨ timer æ€»ç­‰å¾…ï¼Œç»§è€Œè°ƒç”¨ schedule()è¿›è¡Œè°ƒåº¦ï¼Œè®©å…¶ä»– g å¯ä»¥æ‰§è¡Œï¼Œç­‰åˆ° sleep æ—¶é—´åˆ°äº†ï¼Œtimer ä¼šæŠŠä¹‹å‰çš„ g é‡æ–°è®¾ç½®ä¸º _Grunnableï¼Œå¹¶ä¸”é‡æ–°æ”¾å›æœ¬åœ° runq ä¸­</p><p>ä¸€ä¸ªåç¨‹ä¸­ï¼Œä½¿ç”¨ go å…³é”®å­—å¯åŠ¨ä¸€ä¸ªæ–°çš„åç¨‹ï¼Œä¼šæŠŠè¿™ä¸ªæ–°åç¨‹åŠ å…¥è‡ªå·± p çš„æœ¬åœ° runq ä¸­ï¼Œå½“æ—¶å¦‚æœæœ‰æ–°çš„ç©ºé—²çš„ pï¼Œå°±ä¼šå¯åŠ¨æ–°çš„çº¿ç¨‹å…³è”åˆ°è¿™ä¸ªç©ºé—²çš„ pï¼Œå¹¶ä¸”æŠŠè¿™ä¸ªæ–°åç¨‹åŠ å…¥ç©ºé—² p çš„æœ¬åœ° runq ä¸­</p><h2 id="æ–°" tabindex="-1"><a class="header-anchor" href="#æ–°" aria-hidden="true">#</a> æ–°</h2><h2 id="çº¿ç¨‹" tabindex="-1"><a class="header-anchor" href="#çº¿ç¨‹" aria-hidden="true">#</a> çº¿ç¨‹</h2><p>é€šå¸¸è¯­ä¹‰ä¸­çš„çº¿ç¨‹ï¼ŒæŒ‡çš„æ˜¯å†…æ ¸çº§çº¿ç¨‹ï¼Œæ ¸å¿ƒç‚¹å¦‚ä¸‹ï¼š</p><ol><li>æ˜¯æ“ä½œç³»ç»Ÿæœ€å°è°ƒåº¦å•å…ƒ</li><li>åˆ›å»ºã€é”€æ¯ã€è°ƒåº¦äº¤ç”±å†…æ ¸å®Œæˆï¼Œcpu éœ€å®Œæˆç”¨æˆ·æ€ä¸å†…æ ¸æ€é—´çš„åˆ‡æ¢</li><li>å¯å……åˆ†åˆ©ç”¨å¤šæ ¸ï¼Œå®ç°å¹¶è¡Œ</li></ol><h2 id="ä¼ ç»Ÿåç¨‹" tabindex="-1"><a class="header-anchor" href="#ä¼ ç»Ÿåç¨‹" aria-hidden="true">#</a> ä¼ ç»Ÿåç¨‹</h2><p>åç¨‹æ˜¯ç”¨æˆ·æ€ï¼Œä¾èµ–å†…æ ¸çº¿ç¨‹ï¼Œå¹¶ä¸”æ˜¯ 1:N ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œä¸€ä¸ªåç¨‹é˜»å¡ä¼šé€ æˆæ•´ä¸ªåç¨‹ç»„é˜»å¡</p><ol><li>ä¸çº¿ç¨‹å­˜åœ¨æ˜ å°„å…³ç³»ï¼Œä¸º Mï¼š1</li><li>åˆ›å»ºã€é”€æ¯ã€è°ƒåº¦åœ¨ç”¨æˆ·æ€å®Œæˆï¼Œå¯¹å†…æ ¸é€æ˜ï¼Œæ‰€ä»¥æ›´è½»</li><li>ä»å±åŒä¸€ä¸ªå†…æ ¸çº§çº¿ç¨‹ï¼Œæ— æ³•å¹¶è¡Œï¼›ä¸€ä¸ªåç¨‹é˜»å¡ä¼šå¯¼è‡´ä»å±åŒä¸€çº¿ç¨‹çš„æ‰€æœ‰åç¨‹æ— æ³•æ‰§è¡Œ</li></ol><h2 id="goroutine" tabindex="-1"><a class="header-anchor" href="#goroutine" aria-hidden="true">#</a> goroutine</h2><p>go å¯¹åç¨‹åšäº†ä¼˜åŒ–æˆä¸ºäº† goroutineï¼Œåç¨‹å’Œçº¿ç¨‹åŠ äº†ä¸€å±‚è°ƒåº¦ï¼Œå¯ä»¥ N:M å¤šå¯¹å¤šï¼Œå¯ä»¥å¹¶å‘æ‰§è¡Œ</p><ol><li>ä¸çº¿ç¨‹å­˜åœ¨æ˜ å°„å…³ç³»ï¼Œä¸º Mï¼šN</li><li>åˆ›å»ºã€é”€æ¯ã€è°ƒåº¦åœ¨ç”¨æˆ·æ€å®Œæˆï¼Œå¯¹å†…æ ¸é€æ˜ï¼Œè¶³å¤Ÿè½»ä¾¿</li><li>å¯åˆ©ç”¨å¤šä¸ªçº¿ç¨‹ï¼Œå®ç°å¹¶è¡Œ</li><li>é€šè¿‡è°ƒåº¦å™¨çš„æ–¡æ—‹ï¼Œå®ç°å’Œçº¿ç¨‹é—´çš„åŠ¨æ€ç»‘å®šå’Œçµæ´»è°ƒåº¦</li><li>æ ˆç©ºé—´å¤§å°å¯åŠ¨æ€æ‰©ç¼©ï¼Œå› åœ°åˆ¶å®œ</li></ol><h2 id="å¯¹æ¯”" tabindex="-1"><a class="header-anchor" href="#å¯¹æ¯”" aria-hidden="true">#</a> å¯¹æ¯”</h2><p>ä¸‰ä¸ªæ¨¡å‹çš„å„é¡¹èƒ½åŠ›å¯¹æ¯”å¦‚ä¸‹:</p><table><thead><tr><th style="text-align:center;"><strong>æ¨¡å‹</strong></th><th style="text-align:center;"><strong>å¼±ä¾èµ–å†…æ ¸</strong></th><th style="text-align:center;"><strong>å¯å¹¶è¡Œ</strong></th><th style="text-align:center;"><strong>å¯åº”å¯¹é˜»å¡</strong></th><th style="text-align:center;"><strong>æ ˆå¯åŠ¨æ€æ‰©ç¼©</strong></th></tr></thead><tbody><tr><td style="text-align:center;">çº¿ç¨‹</td><td style="text-align:center;">â</td><td style="text-align:center;">âœ…</td><td style="text-align:center;">âœ…</td><td style="text-align:center;">â</td></tr><tr><td style="text-align:center;">åç¨‹</td><td style="text-align:center;">âœ…</td><td style="text-align:center;">â</td><td style="text-align:center;">â</td><td style="text-align:center;">â</td></tr><tr><td style="text-align:center;">goroutine</td><td style="text-align:center;">âœ…</td><td style="text-align:center;">âœ…</td><td style="text-align:center;">âœ…</td><td style="text-align:center;">âœ…</td></tr></tbody></table><h2 id="gmp" tabindex="-1"><a class="header-anchor" href="#gmp" aria-hidden="true">#</a> GMP</h2><ol><li>M æ˜¯çº¿ç¨‹çš„æŠ½è±¡ï¼›G æ˜¯ goroutineï¼›P æ˜¯æ‰¿ä¸Šå¯ä¸‹çš„è°ƒåº¦å™¨</li><li>M è°ƒåº¦ G å‰ï¼Œéœ€è¦å’Œ P ç»‘å®š</li><li>å…¨å±€æœ‰å¤šä¸ª M å’Œå¤šä¸ª Pï¼Œä½†åŒæ—¶å¹¶è¡Œçš„ G çš„æœ€å¤§æ•°é‡ç­‰äº P çš„æ•°é‡</li><li>G çš„å­˜æ”¾é˜Ÿåˆ—æœ‰ä¸‰ç±»ï¼šP çš„æœ¬åœ°é˜Ÿåˆ—ï¼›å…¨å±€é˜Ÿåˆ—ï¼›å’Œ wait é˜Ÿåˆ—ï¼ˆå›¾ä¸­æœªå±•ç¤ºï¼Œä¸º io é˜»å¡å°±ç»ªæ€ goroutine é˜Ÿåˆ—ï¼‰</li><li>M è°ƒåº¦ G æ—¶ï¼Œä¼˜å…ˆå– P æœ¬åœ°é˜Ÿåˆ—ï¼Œå…¶æ¬¡å–å…¨å±€é˜Ÿåˆ—ï¼Œæœ€åå– wait é˜Ÿåˆ—ï¼›è¿™æ ·çš„å¥½å¤„æ˜¯ï¼Œå–æœ¬åœ°é˜Ÿåˆ—æ—¶ï¼Œå¯ä»¥æ¥è¿‘äºæ— é”åŒ–ï¼Œå‡å°‘å…¨å±€é”ç«äº‰</li><li>ä¸ºé˜²æ­¢ä¸åŒ P çš„é—²å¿™å·®å¼‚è¿‡å¤§ï¼Œè®¾ç«‹ work-stealing æœºåˆ¶ï¼Œæœ¬åœ°é˜Ÿåˆ—ä¸ºç©ºçš„ P å¯ä»¥å°è¯•ä»å…¶ä»– P æœ¬åœ°é˜Ÿåˆ—å·å–ä¸€åŠçš„ G è¡¥å……åˆ°è‡ªèº«é˜Ÿåˆ—</li></ol><figure><img src="/assets/go-gmp-f7a999e3.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="g" tabindex="-1"><a class="header-anchor" href="#g" aria-hidden="true">#</a> g</h3><ol><li>g å³ goroutineï¼Œæ˜¯ golang ä¸­å¯¹åç¨‹çš„æŠ½è±¡</li><li>g æœ‰è‡ªå·±çš„è¿è¡Œæ ˆã€çŠ¶æ€ã€ä»¥åŠæ‰§è¡Œçš„ä»»åŠ¡å‡½æ•°ï¼ˆç”¨æˆ·é€šè¿‡ go func æŒ‡å®šï¼‰</li><li>g éœ€è¦ç»‘å®šåˆ° p æ‰èƒ½æ‰§è¡Œï¼Œåœ¨ g çš„è§†è§’ä¸­ï¼Œp å°±æ˜¯å®ƒçš„ cpu</li></ol><p>åŒ…å«<code>mçš„æŒ‡é’ˆ</code></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> g <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// Stack parameters.</span>
	<span class="token comment">// stack describes the actual stack memory: [stack.lo, stack.hi).</span>
	<span class="token comment">// stackguard0 is the stack pointer compared in the Go stack growth prologue.</span>
	<span class="token comment">// It is stack.lo+StackGuard normally, but can be StackPreempt to trigger a preemption.</span>
	<span class="token comment">// stackguard1 is the stack pointer compared in the C stack growth prologue.</span>
	<span class="token comment">// It is stack.lo+StackGuard on g0 and gsignal stacks.</span>
	<span class="token comment">// It is ~0 on other goroutine stacks, to trigger a call to morestackc (and crash).</span>
	stack       stack   <span class="token comment">// offset known to runtime/cgo</span>
	stackguard0 <span class="token builtin">uintptr</span> <span class="token comment">// offset known to liblink</span>
	stackguard1 <span class="token builtin">uintptr</span> <span class="token comment">// offset known to liblink</span>

	_panic    <span class="token operator">*</span>_panic <span class="token comment">// innermost panic - offset known to liblink</span>
	_defer    <span class="token operator">*</span>_defer <span class="token comment">// innermost defer</span>
	m         <span class="token operator">*</span>m      <span class="token comment">// current m; offset known to arm liblink</span>
	sched     gobuf
	syscallsp <span class="token builtin">uintptr</span> <span class="token comment">// if status==Gsyscall, syscallsp = sched.sp to use during gc</span>
	syscallpc <span class="token builtin">uintptr</span> <span class="token comment">// if status==Gsyscall, syscallpc = sched.pc to use during gc</span>
	stktopsp  <span class="token builtin">uintptr</span> <span class="token comment">// expected sp at top of stack, to check in traceback</span>
	<span class="token comment">// param is a generic pointer parameter field used to pass</span>
	<span class="token comment">// values in particular contexts where other storage for the</span>
	<span class="token comment">// parameter would be difficult to find. It is currently used</span>
	<span class="token comment">// in three ways:</span>
	<span class="token comment">// 1. When a channel operation wakes up a blocked goroutine, it sets param to</span>
	<span class="token comment">//    point to the sudog of the completed blocking operation.</span>
	<span class="token comment">// 2. By gcAssistAlloc1 to signal back to its caller that the goroutine completed</span>
	<span class="token comment">//    the GC cycle. It is unsafe to do so in any other way, because the goroutine&#39;s</span>
	<span class="token comment">//    stack may have moved in the meantime.</span>
	<span class="token comment">// 3. By debugCallWrap to pass parameters to a new goroutine because allocating a</span>
	<span class="token comment">//    closure in the runtime is forbidden.</span>
	param        unsafe<span class="token punctuation">.</span>Pointer
	atomicstatus <span class="token builtin">uint32</span>
	stackLock    <span class="token builtin">uint32</span> <span class="token comment">// sigprof/scang lock; TODO: fold in to atomicstatus</span>
	goid         <span class="token builtin">int64</span>
	schedlink    guintptr
	waitsince    <span class="token builtin">int64</span>      <span class="token comment">// approx time when the g become blocked</span>
	waitreason   waitReason <span class="token comment">// if status==Gwaiting</span>

	preempt       <span class="token builtin">bool</span> <span class="token comment">// preemption signal, duplicates stackguard0 = stackpreempt</span>
	preemptStop   <span class="token builtin">bool</span> <span class="token comment">// transition to _Gpreempted on preemption; otherwise, just deschedule</span>
	preemptShrink <span class="token builtin">bool</span> <span class="token comment">// shrink stack at synchronous safe point</span>

	<span class="token comment">// asyncSafePoint is set if g is stopped at an asynchronous</span>
	<span class="token comment">// safe point. This means there are frames on the stack</span>
	<span class="token comment">// without precise pointer information.</span>
	asyncSafePoint <span class="token builtin">bool</span>

	paniconfault <span class="token builtin">bool</span> <span class="token comment">// panic (instead of crash) on unexpected fault address</span>
	gcscandone   <span class="token builtin">bool</span> <span class="token comment">// g has scanned stack; protected by _Gscan bit in status</span>
	throwsplit   <span class="token builtin">bool</span> <span class="token comment">// must not split stack</span>
	<span class="token comment">// activeStackChans indicates that there are unlocked channels</span>
	<span class="token comment">// pointing into this goroutine&#39;s stack. If true, stack</span>
	<span class="token comment">// copying needs to acquire channel locks to protect these</span>
	<span class="token comment">// areas of the stack.</span>
	activeStackChans <span class="token builtin">bool</span>
	<span class="token comment">// parkingOnChan indicates that the goroutine is about to</span>
	<span class="token comment">// park on a chansend or chanrecv. Used to signal an unsafe point</span>
	<span class="token comment">// for stack shrinking. It&#39;s a boolean value, but is updated atomically.</span>
	parkingOnChan <span class="token builtin">uint8</span>

	raceignore     <span class="token builtin">int8</span>     <span class="token comment">// ignore race detection events</span>
	sysblocktraced <span class="token builtin">bool</span>     <span class="token comment">// StartTrace has emitted EvGoInSyscall about this goroutine</span>
	tracking       <span class="token builtin">bool</span>     <span class="token comment">// whether we&#39;re tracking this G for sched latency statistics</span>
	trackingSeq    <span class="token builtin">uint8</span>    <span class="token comment">// used to decide whether to track this G</span>
	runnableStamp  <span class="token builtin">int64</span>    <span class="token comment">// timestamp of when the G last became runnable, only used when tracking</span>
	runnableTime   <span class="token builtin">int64</span>    <span class="token comment">// the amount of time spent runnable, cleared when running, only used when tracking</span>
	sysexitticks   <span class="token builtin">int64</span>    <span class="token comment">// cputicks when syscall has returned (for tracing)</span>
	traceseq       <span class="token builtin">uint64</span>   <span class="token comment">// trace event sequencer</span>
	tracelastp     puintptr <span class="token comment">// last P emitted an event for this goroutine</span>
	lockedm        muintptr
	sig            <span class="token builtin">uint32</span>
	writebuf       <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
	sigcode0       <span class="token builtin">uintptr</span>
	sigcode1       <span class="token builtin">uintptr</span>
	sigpc          <span class="token builtin">uintptr</span>
	gopc           <span class="token builtin">uintptr</span>         <span class="token comment">// pc of go statement that created this goroutine</span>
	ancestors      <span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span>ancestorInfo <span class="token comment">// ancestor information goroutine(s) that created this goroutine (only used if debug.tracebackancestors)</span>
	startpc        <span class="token builtin">uintptr</span>         <span class="token comment">// pc of goroutine function</span>
	racectx        <span class="token builtin">uintptr</span>
	waiting        <span class="token operator">*</span>sudog         <span class="token comment">// sudog structures this g is waiting on (that have a valid elem ptr); in lock order</span>
	cgoCtxt        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uintptr</span>      <span class="token comment">// cgo traceback context</span>
	labels         unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// profiler labels</span>
	timer          <span class="token operator">*</span>timer         <span class="token comment">// cached timer for time.Sleep</span>
	selectDone     <span class="token builtin">uint32</span>         <span class="token comment">// are we participating in a select and did someone win the race?</span>

	<span class="token comment">// Per-G GC state</span>

	<span class="token comment">// gcAssistBytes is this G&#39;s GC assist credit in terms of</span>
	<span class="token comment">// bytes allocated. If this is positive, then the G has credit</span>
	<span class="token comment">// to allocate gcAssistBytes bytes without assisting. If this</span>
	<span class="token comment">// is negative, then the G must correct this by performing</span>
	<span class="token comment">// scan work. We track this in bytes to make it fast to update</span>
	<span class="token comment">// and check for debt in the malloc hot path. The assist ratio</span>
	<span class="token comment">// determines how this corresponds to scan work debt.</span>
	gcAssistBytes <span class="token builtin">int64</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>mï¼šåœ¨ p çš„ä»£ç†ï¼Œè´Ÿè´£æ‰§è¡Œå½“å‰ g çš„ m</li><li>sched.spï¼šä¿å­˜ CPU çš„ rsp å¯„å­˜å™¨çš„å€¼ï¼ŒæŒ‡å‘å‡½æ•°è°ƒç”¨æ ˆæ ˆé¡¶ï¼Œå‚è€ƒ<a href="/go/asm/plan9.html" class="">go plan9 æ±‡ç¼–</a></li><li>sched.pcï¼šä¿å­˜ CPU çš„ rip å¯„å­˜å™¨çš„å€¼ï¼ŒæŒ‡å‘ç¨‹åºä¸‹ä¸€æ¡æ‰§è¡ŒæŒ‡ä»¤çš„åœ°å€</li><li>sched.retï¼šä¿å­˜ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼</li><li>sched.bpï¼šä¿å­˜ CPU çš„ rbp å¯„å­˜å™¨çš„å€¼ï¼Œå­˜å‚¨å‡½æ•°æ ˆå¸§çš„èµ·å§‹ä½ç½®</li></ol><h4 id="g-çš„çŠ¶æ€" tabindex="-1"><a class="header-anchor" href="#g-çš„çŠ¶æ€" aria-hidden="true">#</a> g çš„çŠ¶æ€</h4><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">const</span> <span class="token punctuation">(</span>
	<span class="token comment">// G status</span>
	<span class="token comment">//</span>
	<span class="token comment">// Beyond indicating the general state of a G, the G status</span>
	<span class="token comment">// acts like a lock on the goroutine&#39;s stack (and hence its</span>
	<span class="token comment">// ability to execute user code).</span>
	<span class="token comment">//</span>
	<span class="token comment">// If you add to this list, add to the list</span>
	<span class="token comment">// of &quot;okay during garbage collection&quot; status</span>
	<span class="token comment">// in mgcmark.go too.</span>
	<span class="token comment">//</span>
	<span class="token comment">// TODO(austin): The _Gscan bit could be much lighter-weight.</span>
	<span class="token comment">// For example, we could choose not to run _Gscanrunnable</span>
	<span class="token comment">// goroutines found in the run queue, rather than CAS-looping</span>
	<span class="token comment">// until they become _Grunnable. And transitions like</span>
	<span class="token comment">// _Gscanwaiting -&gt; _Gscanrunnable are actually okay because</span>
	<span class="token comment">// they don&#39;t affect stack ownership.</span>

	<span class="token comment">// _Gidle means this goroutine was just allocated and has not</span>
	<span class="token comment">// yet been initialized.</span>
	_Gidle <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token comment">// 0</span>

	<span class="token comment">// _Grunnable means this goroutine is on a run queue. It is</span>
	<span class="token comment">// not currently executing user code. The stack is not owned.</span>
	_Grunnable <span class="token comment">// 1</span>

	<span class="token comment">// _Grunning means this goroutine may execute user code. The</span>
	<span class="token comment">// stack is owned by this goroutine. It is not on a run queue.</span>
	<span class="token comment">// It is assigned an M and a P (g.m and g.m.p are valid).</span>
	_Grunning <span class="token comment">// 2</span>

	<span class="token comment">// _Gsyscall means this goroutine is executing a system call.</span>
	<span class="token comment">// It is not executing user code. The stack is owned by this</span>
	<span class="token comment">// goroutine. It is not on a run queue. It is assigned an M.</span>
	_Gsyscall <span class="token comment">// 3</span>

	<span class="token comment">// _Gwaiting means this goroutine is blocked in the runtime.</span>
	<span class="token comment">// It is not executing user code. It is not on a run queue,</span>
	<span class="token comment">// but should be recorded somewhere (e.g., a channel wait</span>
	<span class="token comment">// queue) so it can be ready()d when necessary. The stack is</span>
	<span class="token comment">// not owned *except* that a channel operation may read or</span>
	<span class="token comment">// write parts of the stack under the appropriate channel</span>
	<span class="token comment">// lock. Otherwise, it is not safe to access the stack after a</span>
	<span class="token comment">// goroutine enters _Gwaiting (e.g., it may get moved).</span>
	_Gwaiting <span class="token comment">// 4</span>

	<span class="token comment">// _Gmoribund_unused is currently unused, but hardcoded in gdb</span>
	<span class="token comment">// scripts.</span>
	_Gmoribund_unused <span class="token comment">// 5</span>

	<span class="token comment">// _Gdead means this goroutine is currently unused. It may be</span>
	<span class="token comment">// just exited, on a free list, or just being initialized. It</span>
	<span class="token comment">// is not executing user code. It may or may not have a stack</span>
	<span class="token comment">// allocated. The G and its stack (if any) are owned by the M</span>
	<span class="token comment">// that is exiting the G or that obtained the G from the free</span>
	<span class="token comment">// list.</span>
	_Gdead <span class="token comment">// 6</span>

	<span class="token comment">// _Genqueue_unused is currently unused.</span>
	_Genqueue_unused <span class="token comment">// 7</span>

	<span class="token comment">// _Gcopystack means this goroutine&#39;s stack is being moved. It</span>
	<span class="token comment">// is not executing user code and is not on a run queue. The</span>
	<span class="token comment">// stack is owned by the goroutine that put it in _Gcopystack.</span>
	_Gcopystack <span class="token comment">// 8</span>

	<span class="token comment">// _Gpreempted means this goroutine stopped itself for a</span>
	<span class="token comment">// suspendG preemption. It is like _Gwaiting, but nothing is</span>
	<span class="token comment">// yet responsible for ready()ing it. Some suspendG must CAS</span>
	<span class="token comment">// the status to _Gwaiting to take responsibility for</span>
	<span class="token comment">// ready()ing this G.</span>
	_Gpreempted <span class="token comment">// 9</span>

	_Gscan          <span class="token operator">=</span> <span class="token number">0x1000</span>
	_Gscanrunnable  <span class="token operator">=</span> _Gscan <span class="token operator">+</span> _Grunnable  <span class="token comment">// 0x1001</span>
	_Gscanrunning   <span class="token operator">=</span> _Gscan <span class="token operator">+</span> _Grunning   <span class="token comment">// 0x1002</span>
	_Gscansyscall   <span class="token operator">=</span> _Gscan <span class="token operator">+</span> _Gsyscall   <span class="token comment">// 0x1003</span>
	_Gscanwaiting   <span class="token operator">=</span> _Gscan <span class="token operator">+</span> _Gwaiting   <span class="token comment">// 0x1004</span>
	_Gscanpreempted <span class="token operator">=</span> _Gscan <span class="token operator">+</span> _Gpreempted <span class="token comment">// 0x1009</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>_Gidle å€¼ä¸º 0ï¼Œä¸ºåç¨‹å¼€å§‹åˆ›å»ºæ—¶çš„çŠ¶æ€ï¼Œæ­¤æ—¶å°šæœªåˆå§‹åŒ–å®Œæˆ</li><li>_Grunnable å€¼ ä¸º 1ï¼Œåç¨‹åœ¨å¾…æ‰§è¡Œé˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…è¢«æ‰§è¡Œ</li><li>_Grunning å€¼ä¸º 2ï¼Œåç¨‹æ­£åœ¨æ‰§è¡Œï¼ŒåŒä¸€æ—¶åˆ»ä¸€ä¸ª p ä¸­åªæœ‰ä¸€ä¸ª g å¤„äºæ­¤çŠ¶æ€</li><li>_Gsyscall å€¼ä¸º 3ï¼Œåç¨‹æ­£åœ¨æ‰§è¡Œç³»ç»Ÿè°ƒç”¨</li><li>_Gwaiting å€¼ä¸º 4ï¼Œåç¨‹å¤„äºæŒ‚èµ·æ€ï¼Œéœ€è¦ç­‰å¾…è¢«å”¤é†’. gcã€channel é€šä¿¡æˆ–è€…é”æ“ä½œæ—¶ç»å¸¸ä¼šè¿›å…¥è¿™ç§çŠ¶æ€</li><li>_Gdead å€¼ä¸º 6ï¼Œåç¨‹åˆš<code>åˆå§‹åŒ–å®Œæˆ</code>æˆ–è€…<code>å·²ç»è¢«é”€æ¯</code>ï¼Œä¼šå¤„äºæ­¤çŠ¶æ€</li><li>_Gcopystack å€¼ä¸º 8ï¼Œåç¨‹æ­£åœ¨æ ˆæ‰©å®¹æµç¨‹ä¸­</li><li>_Greempted å€¼ä¸º 9ï¼Œåç¨‹è¢«æŠ¢å åçš„çŠ¶æ€</li></ol><h3 id="m" tabindex="-1"><a class="header-anchor" href="#m" aria-hidden="true">#</a> m</h3><ol><li>m å³ machineï¼Œæ˜¯ golang ä¸­å¯¹çº¿ç¨‹çš„æŠ½è±¡</li><li>m ä¸ç›´æ¥æ‰§è¡Œ gï¼Œè€Œæ˜¯å…ˆå’Œ p ç»‘å®šï¼Œç”±å…¶å®ç°ä»£ç†</li><li>å€Ÿç”± p çš„å­˜åœ¨ï¼Œm æ— éœ€å’Œ g ç»‘æ­»ï¼Œä¹Ÿæ— éœ€è®°å½• g çš„çŠ¶æ€ä¿¡æ¯ï¼Œå› æ­¤ g åœ¨å…¨ç”Ÿå‘½å‘¨æœŸä¸­å¯ä»¥å®ç°è·¨ m æ‰§è¡Œ</li></ol><p>åŒ…å«<code>g0çš„æŒ‡é’ˆ</code>ï¼Œg0 ä¸æ˜¯ç”¨æˆ·åç¨‹ï¼Œè€Œæ˜¯è´Ÿè´£ g ä¹‹é—´çš„åˆ‡æ¢è°ƒåº¦</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> m <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	g0      <span class="token operator">*</span>g     <span class="token comment">// goroutine with scheduling stack</span>
	morebuf gobuf  <span class="token comment">// gobuf arg to morestack</span>
	divmod  <span class="token builtin">uint32</span> <span class="token comment">// div/mod denominator for arm - known to liblink</span>
	<span class="token boolean">_</span>       <span class="token builtin">uint32</span> <span class="token comment">// align next field to 8 bytes</span>

	<span class="token comment">// Fields not known to debuggers.</span>
	procid        <span class="token builtin">uint64</span>            <span class="token comment">// for debuggers, but offset not hard-coded</span>
	gsignal       <span class="token operator">*</span>g                <span class="token comment">// signal-handling g</span>
	goSigStack    gsignalStack      <span class="token comment">// Go-allocated signal handling stack</span>
	sigmask       sigset            <span class="token comment">// storage for saved signal mask</span>
	tls           <span class="token punctuation">[</span>tlsSlots<span class="token punctuation">]</span><span class="token builtin">uintptr</span> <span class="token comment">// thread-local storage (for x86 extern register)</span>
	mstartfn      <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	curg          <span class="token operator">*</span>g       <span class="token comment">// current running goroutine</span>
	caughtsig     guintptr <span class="token comment">// goroutine running during fatal signal</span>
	p             puintptr <span class="token comment">// attached p for executing go code (nil if not executing go code)</span>
	nextp         puintptr
	oldp          puintptr <span class="token comment">// the p that was attached before executing a syscall</span>
	id            <span class="token builtin">int64</span>
	mallocing     <span class="token builtin">int32</span>
	throwing      <span class="token builtin">int32</span>
	preemptoff    <span class="token builtin">string</span> <span class="token comment">// if != &quot;&quot;, keep curg running on this m</span>
	locks         <span class="token builtin">int32</span>
	dying         <span class="token builtin">int32</span>
	profilehz     <span class="token builtin">int32</span>
	spinning      <span class="token builtin">bool</span> <span class="token comment">// m is out of work and is actively looking for work</span>
	blocked       <span class="token builtin">bool</span> <span class="token comment">// m is blocked on a note</span>
	newSigstack   <span class="token builtin">bool</span> <span class="token comment">// minit on C thread called sigaltstack</span>
	printlock     <span class="token builtin">int8</span>
	incgo         <span class="token builtin">bool</span>   <span class="token comment">// m is executing a cgo call</span>
	freeWait      <span class="token builtin">uint32</span> <span class="token comment">// if == 0, safe to free g0 and delete m (atomic)</span>
	fastrand      <span class="token builtin">uint64</span>
	needextram    <span class="token builtin">bool</span>
	traceback     <span class="token builtin">uint8</span>
	ncgocall      <span class="token builtin">uint64</span>      <span class="token comment">// number of cgo calls in total</span>
	ncgo          <span class="token builtin">int32</span>       <span class="token comment">// number of cgo calls currently in progress</span>
	cgoCallersUse <span class="token builtin">uint32</span>      <span class="token comment">// if non-zero, cgoCallers in use temporarily</span>
	cgoCallers    <span class="token operator">*</span>cgoCallers <span class="token comment">// cgo traceback if crashing in cgo call</span>
	park          note
	alllink       <span class="token operator">*</span>m <span class="token comment">// on allm</span>
	schedlink     muintptr
	lockedg       guintptr
	createstack   <span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token builtin">uintptr</span> <span class="token comment">// stack that created this thread.</span>
	lockedExt     <span class="token builtin">uint32</span>      <span class="token comment">// tracking for external LockOSThread</span>
	lockedInt     <span class="token builtin">uint32</span>      <span class="token comment">// tracking for internal lockOSThread</span>
	nextwaitm     muintptr    <span class="token comment">// next m waiting for lock</span>
	waitunlockf   <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>g<span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token builtin">bool</span>
	waitlock      unsafe<span class="token punctuation">.</span>Pointer
	waittraceev   <span class="token builtin">byte</span>
	waittraceskip <span class="token builtin">int</span>
	startingtrace <span class="token builtin">bool</span>
	syscalltick   <span class="token builtin">uint32</span>
	freelink      <span class="token operator">*</span>m <span class="token comment">// on sched.freem</span>

	<span class="token comment">// these are here because they are too large to be on the stack</span>
	<span class="token comment">// of low-level NOSPLIT functions.</span>
	libcall   libcall
	libcallpc <span class="token builtin">uintptr</span> <span class="token comment">// for cpu profiler</span>
	libcallsp <span class="token builtin">uintptr</span>
	libcallg  guintptr
	syscall   libcall <span class="token comment">// stores syscall parameters on windows</span>

	vdsoSP <span class="token builtin">uintptr</span> <span class="token comment">// SP for traceback while in VDSO call (0 if not in call)</span>
	vdsoPC <span class="token builtin">uintptr</span> <span class="token comment">// PC for traceback while in VDSO call</span>

	<span class="token comment">// preemptGen counts the number of completed preemption</span>
	<span class="token comment">// signals. This is used to detect when a preemption is</span>
	<span class="token comment">// requested, but fails. Accessed atomically.</span>
	preemptGen <span class="token builtin">uint32</span>

	<span class="token comment">// Whether this is a pending preemption signal on this M.</span>
	<span class="token comment">// Accessed atomically.</span>
	signalPending <span class="token builtin">uint32</span>

	dlogPerM

	mOS

	<span class="token comment">// Up to 10 locks held by this m, maintained by the lock ranking code.</span>
	locksHeldLen <span class="token builtin">int</span>
	locksHeld    <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span>heldLockInfo
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>g0ï¼šä¸€ç±»ç‰¹æ®Šçš„è°ƒåº¦åç¨‹ï¼Œä¸ç”¨äºæ‰§è¡Œç”¨æˆ·å‡½æ•°ï¼Œè´Ÿè´£æ‰§è¡Œ g ä¹‹é—´çš„åˆ‡æ¢è°ƒåº¦. ä¸ m çš„å…³ç³»ä¸º 1:1</li><li>tlsï¼šthread-local storageï¼Œçº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼Œå­˜å‚¨å†…å®¹åªå¯¹å½“å‰çº¿ç¨‹å¯è§. çº¿ç¨‹æœ¬åœ°å­˜å‚¨çš„æ˜¯ m.tls çš„åœ°å€ï¼Œm.tls[0] å­˜å‚¨çš„æ˜¯å½“å‰è¿è¡Œçš„ gï¼Œå› æ­¤çº¿ç¨‹å¯ä»¥é€šè¿‡ g æ‰¾åˆ°å½“å‰çš„ mã€pã€g0 ç­‰ä¿¡æ¯</li></ol><h3 id="p" tabindex="-1"><a class="header-anchor" href="#p" aria-hidden="true">#</a> p</h3><ol><li>p å³ processorï¼Œæ˜¯ golang ä¸­çš„è°ƒåº¦å™¨</li><li>p æ˜¯ gmp çš„ä¸­æ¢ï¼Œå€Ÿç”± p æ‰¿ä¸Šå¯ä¸‹ï¼Œå®ç° g å’Œ m ä¹‹é—´çš„åŠ¨æ€æœ‰æœºç»“åˆ</li><li>å¯¹ g è€Œè¨€ï¼Œp æ˜¯å…¶ cpuï¼Œg åªæœ‰è¢« p è°ƒåº¦ï¼Œæ‰å¾—ä»¥æ‰§è¡Œ</li><li>å¯¹ m è€Œè¨€ï¼Œp æ˜¯å…¶æ‰§è¡Œä»£ç†ï¼Œä¸ºå…¶æä¾›å¿…è¦ä¿¡æ¯çš„åŒæ—¶ï¼ˆå¯æ‰§è¡Œçš„ gã€å†…å­˜åˆ†é…æƒ…å†µç­‰ï¼‰ï¼Œå¹¶éšè—äº†ç¹æ‚çš„è°ƒåº¦ç»†èŠ‚</li><li>p çš„æ•°é‡å†³å®šäº† g æœ€å¤§å¹¶è¡Œæ•°é‡ï¼Œå¯ç”±ç”¨æˆ·é€šè¿‡ GOMAXPROCS è¿›è¡Œè®¾å®šï¼ˆè¶…è¿‡ CPU æ ¸æ•°æ—¶æ— æ„ä¹‰ï¼‰</li></ol><p>åŒ…å« runq æœ¬é˜Ÿ g çš„é˜Ÿåˆ—ï¼Œå¤´æ ‡è¯†ï¼Œå°¾æ ‡è¯†ï¼Œä¸‹ä¸€ä¸ªæ‰§è¡Œçš„ p</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> p <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	id          <span class="token builtin">int32</span>
	status      <span class="token builtin">uint32</span> <span class="token comment">// one of pidle/prunning/...</span>
	link        puintptr
	schedtick   <span class="token builtin">uint32</span>     <span class="token comment">// incremented on every scheduler call</span>
	syscalltick <span class="token builtin">uint32</span>     <span class="token comment">// incremented on every system call</span>
	sysmontick  sysmontick <span class="token comment">// last tick observed by sysmon</span>
	m           muintptr   <span class="token comment">// back-link to associated m (nil if idle)</span>
	mcache      <span class="token operator">*</span>mcache
	pcache      pageCache
	raceprocctx <span class="token builtin">uintptr</span>

	deferpool    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>_defer <span class="token comment">// pool of available defer structs (see panic.go)</span>
	deferpoolbuf <span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token operator">*</span>_defer

	<span class="token comment">// Cache of goroutine ids, amortizes accesses to runtimeÂ·sched.goidgen.</span>
	goidcache    <span class="token builtin">uint64</span>
	goidcacheend <span class="token builtin">uint64</span>

	<span class="token comment">// Queue of runnable goroutines. Accessed without lock.</span>
	runqhead <span class="token builtin">uint32</span>
	runqtail <span class="token builtin">uint32</span>
	runq     <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span>guintptr
	<span class="token comment">// runnext, if non-nil, is a runnable G that was ready&#39;d by</span>
	<span class="token comment">// the current G and should be run next instead of what&#39;s in</span>
	<span class="token comment">// runq if there&#39;s time remaining in the running G&#39;s time</span>
	<span class="token comment">// slice. It will inherit the time left in the current time</span>
	<span class="token comment">// slice. If a set of goroutines is locked in a</span>
	<span class="token comment">// communicate-and-wait pattern, this schedules that set as a</span>
	<span class="token comment">// unit and eliminates the (potentially large) scheduling</span>
	<span class="token comment">// latency that otherwise arises from adding the ready&#39;d</span>
	<span class="token comment">// goroutines to the end of the run queue.</span>
	<span class="token comment">//</span>
	<span class="token comment">// Note that while other P&#39;s may atomically CAS this to zero,</span>
	<span class="token comment">// only the owner P can CAS it to a valid G.</span>
	runnext guintptr

	<span class="token comment">// Available G&#39;s (status == Gdead)</span>
	gFree <span class="token keyword">struct</span> <span class="token punctuation">{</span>
		gList
		n <span class="token builtin">int32</span>
	<span class="token punctuation">}</span>

	sudogcache <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>sudog
	sudogbuf   <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token operator">*</span>sudog

	<span class="token comment">// Cache of mspan objects from the heap.</span>
	mspancache <span class="token keyword">struct</span> <span class="token punctuation">{</span>
		<span class="token comment">// We need an explicit length here because this field is used</span>
		<span class="token comment">// in allocation codepaths where write barriers are not allowed,</span>
		<span class="token comment">// and eliminating the write barrier/keeping it eliminated from</span>
		<span class="token comment">// slice updates is tricky, moreso than just managing the length</span>
		<span class="token comment">// ourselves.</span>
		<span class="token builtin">len</span> <span class="token builtin">int</span>
		buf <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token operator">*</span>mspan
	<span class="token punctuation">}</span>

	tracebuf traceBufPtr

	<span class="token comment">// traceSweep indicates the sweep events should be traced.</span>
	<span class="token comment">// This is used to defer the sweep start event until a span</span>
	<span class="token comment">// has actually been swept.</span>
	traceSweep <span class="token builtin">bool</span>
	<span class="token comment">// traceSwept and traceReclaimed track the number of bytes</span>
	<span class="token comment">// swept and reclaimed by sweeping in the current sweep loop.</span>
	traceSwept<span class="token punctuation">,</span> traceReclaimed <span class="token builtin">uintptr</span>

	palloc persistentAlloc <span class="token comment">// per-P to avoid mutex</span>

	<span class="token boolean">_</span> <span class="token builtin">uint32</span> <span class="token comment">// Alignment for atomic fields below</span>

	<span class="token comment">// The when field of the first entry on the timer heap.</span>
	<span class="token comment">// This is updated using atomic functions.</span>
	<span class="token comment">// This is 0 if the timer heap is empty.</span>
	timer0When <span class="token builtin">uint64</span>

	<span class="token comment">// The earliest known nextwhen field of a timer with</span>
	<span class="token comment">// timerModifiedEarlier status. Because the timer may have been</span>
	<span class="token comment">// modified again, there need not be any timer with this value.</span>
	<span class="token comment">// This is updated using atomic functions.</span>
	<span class="token comment">// This is 0 if there are no timerModifiedEarlier timers.</span>
	timerModifiedEarliest <span class="token builtin">uint64</span>

	<span class="token comment">// Per-P GC state</span>
	gcAssistTime         <span class="token builtin">int64</span> <span class="token comment">// Nanoseconds in assistAlloc</span>
	gcFractionalMarkTime <span class="token builtin">int64</span> <span class="token comment">// Nanoseconds in fractional mark worker (atomic)</span>

	<span class="token comment">// gcMarkWorkerMode is the mode for the next mark worker to run in.</span>
	<span class="token comment">// That is, this is used to communicate with the worker goroutine</span>
	<span class="token comment">// selected for immediate execution by</span>
	<span class="token comment">// gcController.findRunnableGCWorker. When scheduling other goroutines,</span>
	<span class="token comment">// this field must be set to gcMarkWorkerNotWorker.</span>
	gcMarkWorkerMode gcMarkWorkerMode
	<span class="token comment">// gcMarkWorkerStartTime is the nanotime() at which the most recent</span>
	<span class="token comment">// mark worker started.</span>
	gcMarkWorkerStartTime <span class="token builtin">int64</span>

	<span class="token comment">// gcw is this P&#39;s GC work buffer cache. The work buffer is</span>
	<span class="token comment">// filled by write barriers, drained by mutator assists, and</span>
	<span class="token comment">// disposed on certain GC state transitions.</span>
	gcw gcWork

	<span class="token comment">// wbBuf is this P&#39;s GC write barrier buffer.</span>
	<span class="token comment">//</span>
	<span class="token comment">// TODO: Consider caching this in the running G.</span>
	wbBuf wbBuf

	runSafePointFn <span class="token builtin">uint32</span> <span class="token comment">// if 1, run sched.safePointFn at next safe point</span>

	<span class="token comment">// statsSeq is a counter indicating whether this P is currently</span>
	<span class="token comment">// writing any stats. Its value is even when not, odd when it is.</span>
	statsSeq <span class="token builtin">uint32</span>

	<span class="token comment">// Lock for timers. We normally access the timers while running</span>
	<span class="token comment">// on this P, but the scheduler can also do it from a different P.</span>
	timersLock mutex

	<span class="token comment">// Actions to take at some time. This is used to implement the</span>
	<span class="token comment">// standard library&#39;s time package.</span>
	<span class="token comment">// Must hold timersLock to access.</span>
	timers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>timer

	<span class="token comment">// Number of timers in P&#39;s heap.</span>
	<span class="token comment">// Modified using atomic instructions.</span>
	numTimers <span class="token builtin">uint32</span>

	<span class="token comment">// Number of timerDeleted timers in P&#39;s heap.</span>
	<span class="token comment">// Modified using atomic instructions.</span>
	deletedTimers <span class="token builtin">uint32</span>

	<span class="token comment">// Race context used while executing timer functions.</span>
	timerRaceCtx <span class="token builtin">uintptr</span>

	<span class="token comment">// scannableStackSizeDelta accumulates the amount of stack space held by</span>
	<span class="token comment">// live goroutines (i.e. those eligible for stack scanning).</span>
	<span class="token comment">// Flushed to gcController.scannableStackSize once scannableStackSizeSlack</span>
	<span class="token comment">// or -scannableStackSizeSlack is reached.</span>
	scannableStackSizeDelta <span class="token builtin">int64</span>

	<span class="token comment">// preempt is set to indicate that this P should be enter the</span>
	<span class="token comment">// scheduler ASAP (regardless of what G is running on it).</span>
	preempt <span class="token builtin">bool</span>

	<span class="token comment">// Padding is no longer needed. False sharing is now not a worry because p is large enough</span>
	<span class="token comment">// that its size class is an integer multiple of the cache line size (for any of our architectures).</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>runqï¼šæœ¬åœ° goroutine é˜Ÿåˆ—ï¼Œæœ€å¤§é•¿åº¦ä¸º 256</li><li>runqheadï¼šé˜Ÿåˆ—å¤´éƒ¨</li><li>runqtailï¼šé˜Ÿåˆ—å°¾éƒ¨</li><li>runnextï¼šä¸‹ä¸€ä¸ªå¯æ‰§è¡Œçš„ goroutine</li></ol><h3 id="å…¨å±€é˜Ÿåˆ—" tabindex="-1"><a class="header-anchor" href="#å…¨å±€é˜Ÿåˆ—" aria-hidden="true">#</a> å…¨å±€é˜Ÿåˆ—</h3><p>sched æ˜¯å…¨å±€ goroutine é˜Ÿåˆ—çš„å°è£…ï¼Œå› ä¸º p å¯ä»¥è·å–è¿™é‡Œé¢çš„ gï¼Œæ‰€ä»¥åŒ…å«äº†é”</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> schedt <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// accessed atomically. keep at top to ensure alignment on 32-bit systems.</span>
	goidgen   <span class="token builtin">uint64</span>
	lastpoll  <span class="token builtin">uint64</span> <span class="token comment">// time of last network poll, 0 if currently polling</span>
	pollUntil <span class="token builtin">uint64</span> <span class="token comment">// time to which current poll is sleeping</span>

	lock mutex

	<span class="token comment">// When increasing nmidle, nmidlelocked, nmsys, or nmfreed, be</span>
	<span class="token comment">// sure to call checkdead().</span>

	midle        muintptr <span class="token comment">// idle m&#39;s waiting for work</span>
	nmidle       <span class="token builtin">int32</span>    <span class="token comment">// number of idle m&#39;s waiting for work</span>
	nmidlelocked <span class="token builtin">int32</span>    <span class="token comment">// number of locked m&#39;s waiting for work</span>
	mnext        <span class="token builtin">int64</span>    <span class="token comment">// number of m&#39;s that have been created and next M ID</span>
	maxmcount    <span class="token builtin">int32</span>    <span class="token comment">// maximum number of m&#39;s allowed (or die)</span>
	nmsys        <span class="token builtin">int32</span>    <span class="token comment">// number of system m&#39;s not counted for deadlock</span>
	nmfreed      <span class="token builtin">int64</span>    <span class="token comment">// cumulative number of freed m&#39;s</span>

	ngsys <span class="token builtin">uint32</span> <span class="token comment">// number of system goroutines; updated atomically</span>

	pidle      puintptr <span class="token comment">// idle p&#39;s</span>
	npidle     <span class="token builtin">uint32</span>
	nmspinning <span class="token builtin">uint32</span> <span class="token comment">// See &quot;Worker thread parking/unparking&quot; comment in proc.go.</span>

	<span class="token comment">// Global runnable queue.</span>
	runq     gQueue
	runqsize <span class="token builtin">int32</span>

	<span class="token comment">// disable controls selective disabling of the scheduler.</span>
	<span class="token comment">//</span>
	<span class="token comment">// Use schedEnableUser to control this.</span>
	<span class="token comment">//</span>
	<span class="token comment">// disable is protected by sched.lock.</span>
	disable <span class="token keyword">struct</span> <span class="token punctuation">{</span>
		<span class="token comment">// user disables scheduling of user goroutines.</span>
		user     <span class="token builtin">bool</span>
		runnable gQueue <span class="token comment">// pending runnable Gs</span>
		n        <span class="token builtin">int32</span>  <span class="token comment">// length of runnable</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Global cache of dead G&#39;s.</span>
	gFree <span class="token keyword">struct</span> <span class="token punctuation">{</span>
		lock    mutex
		stack   gList <span class="token comment">// Gs with stacks</span>
		noStack gList <span class="token comment">// Gs without stacks</span>
		n       <span class="token builtin">int32</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Central cache of sudog structs.</span>
	sudoglock  mutex
	sudogcache <span class="token operator">*</span>sudog

	<span class="token comment">// Central pool of available defer structs.</span>
	deferlock mutex
	deferpool <span class="token operator">*</span>_defer

	<span class="token comment">// freem is the list of m&#39;s waiting to be freed when their</span>
	<span class="token comment">// m.exited is set. Linked through m.freelink.</span>
	freem <span class="token operator">*</span>m

	gcwaiting  <span class="token builtin">uint32</span> <span class="token comment">// gc is waiting to run</span>
	stopwait   <span class="token builtin">int32</span>
	stopnote   note
	sysmonwait <span class="token builtin">uint32</span>
	sysmonnote note

	<span class="token comment">// safepointFn should be called on each P at the next GC</span>
	<span class="token comment">// safepoint if p.runSafePointFn is set.</span>
	safePointFn   <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token punctuation">)</span>
	safePointWait <span class="token builtin">int32</span>
	safePointNote note

	profilehz <span class="token builtin">int32</span> <span class="token comment">// cpu profiling rate</span>

	procresizetime <span class="token builtin">int64</span> <span class="token comment">// nanotime() of last change to gomaxprocs</span>
	totaltime      <span class="token builtin">int64</span> <span class="token comment">// âˆ«gomaxprocs dt up to procresizetime</span>

	<span class="token comment">// sysmonlock protects sysmon&#39;s actions on the runtime.</span>
	<span class="token comment">//</span>
	<span class="token comment">// Acquire and hold this mutex to block sysmon from interacting</span>
	<span class="token comment">// with the rest of the runtime.</span>
	sysmonlock mutex

	<span class="token comment">// timeToRun is a distribution of scheduling latencies, defined</span>
	<span class="token comment">// as the sum of time a G spends in the _Grunnable state before</span>
	<span class="token comment">// it transitions to _Grunning.</span>
	<span class="token comment">//</span>
	<span class="token comment">// timeToRun is protected by sched.lock.</span>
	timeToRun timeHistogram
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>lockï¼šä¸€æŠŠæ“ä½œå…¨å±€é˜Ÿåˆ—æ—¶ä½¿ç”¨çš„é”</li><li>runqï¼šå…¨å±€ goroutine é˜Ÿåˆ—</li><li>runqsizeï¼šå…¨å±€ goroutine é˜Ÿåˆ—çš„å®¹é‡</li></ol><h2 id="è°ƒåº¦" tabindex="-1"><a class="header-anchor" href="#è°ƒåº¦" aria-hidden="true">#</a> è°ƒåº¦</h2><p>æœ‰ä¸¤ç§ gï¼Œä¸€ç§ g0ï¼Œä¸€ç§æ™®é€š gï¼Œm é€šè¿‡ p è°ƒåº¦æ‰§è¡Œçš„ goroutine æ°¸è¿œåœ¨æ™®é€š g å’Œ g0 ä¹‹é—´è¿›è¡Œåˆ‡æ¢</p><p>g0 é€šè¿‡<code>func gogo(buf *gobuf)</code>è°ƒåº¦ gï¼Œg éœ€è¦ä¸»åŠ¨è®©æ¸¡æˆ–è¢«åŠ¨è°ƒåº¦æ—¶ï¼Œå†é€šè¿‡<code>func mcall(fn func(*g))</code>äº¤è¿˜æ‰§è¡Œæƒ</p><h3 id="è°ƒåº¦ç±»å‹" tabindex="-1"><a class="header-anchor" href="#è°ƒåº¦ç±»å‹" aria-hidden="true">#</a> è°ƒåº¦ç±»å‹</h3><figure><img src="/assets/gmp-gosched-f3bb8114.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>g åŒ…å« mï¼Œm åŒ…å« g0ï¼Œp å’Œ m ç»‘å®šæˆ–è€…è§£ç»‘ï¼Œp åŒ…å«æœ¬åœ° g çš„é˜Ÿåˆ—</p><h4 id="ä¸»åŠ¨è°ƒåº¦" tabindex="-1"><a class="header-anchor" href="#ä¸»åŠ¨è°ƒåº¦" aria-hidden="true">#</a> ä¸»åŠ¨è°ƒåº¦</h4><p>ç”¨æˆ·æ‰§è¡Œ runtime ä¸‹<code>func Gosched()</code>å½“å‰çš„ g ä¼šä¸»åŠ¨è®©å‡º p çš„æ‰§è¡Œæƒï¼Œä» running çŠ¶æ€è½¬æ¢æˆ runnable çŠ¶æ€ï¼Œå¹¶ä¸”æ”¾åˆ°å…¨å±€é˜Ÿåˆ—ä¸­ï¼Œè€Œä¸”è¿™ä¸ª g å¯¹åº”çš„ m çš„ g0 ä¼šé‡æ–°å¯»æ‰¾å…¶ä»–å¯æ‰§è¡Œçš„ g</p><h4 id="è¢«åŠ¨è°ƒåº¦" tabindex="-1"><a class="header-anchor" href="#è¢«åŠ¨è°ƒåº¦" aria-hidden="true">#</a> è¢«åŠ¨è°ƒåº¦</h4><p>å…¸å‹åœºæ™¯ï¼Œè·å–é”å¤±è´¥è¢«é˜»å¡ï¼›å†™ä¸€ä¸ªæ»¡çš„ chanï¼Œæˆ–è€…è¯»ä¸€ç©º chan éƒ½ä¼šé™·å…¥é˜»å¡ï¼›ä¸»è¦ä¾èµ– <code>func gopark()</code>ï¼Œg çš„çŠ¶æ€å˜ä¸º waiting çŠ¶æ€</p><p>ä¸ä¹‹å¯¹äºçš„<code>func goready()</code>ï¼Œå¯ä»¥å”¤é†’ gï¼Œä» waiting çŠ¶æ€å˜æˆ runnable çŠ¶æ€ï¼Œå…¸å‹åœºæ™¯æ˜¯ g1 è¯»å”¤é†’å†™çš„ g2ï¼ˆè¿™ä¸ª g2 å†™ä¸€ä¸ªæ»¡ chan æƒ…å†µä¸‹ï¼‰ï¼Œg3 å†™å”¤é†’ g4ï¼ˆè¿™ä¸ª g4 åº¦ä¸€ç©º chan æƒ…å†µä¸‹ï¼‰ï¼Œå”¤é†’çš„ç›®æ ‡ g ä¼˜å…ˆè¢«å½“å‰ g æ‰€åœ¨çš„ p æ”¾å…¥æœ¬åœ°é˜Ÿåˆ—ä¸­ï¼Œå‚è€ƒ<a href="/source-code/go-standard-lib/channel/chan.html" class="">channel æºç è§£è¯»</a></p><h4 id="æ­£å¸¸è°ƒåº¦" tabindex="-1"><a class="header-anchor" href="#æ­£å¸¸è°ƒåº¦" aria-hidden="true">#</a> æ­£å¸¸è°ƒåº¦</h4><p>æ¯”è¾ƒç®€å•ï¼Œg ä¸­çš„æ‰§è¡Œä»»åŠ¡å·²å®Œæˆï¼Œg0 ä¼šå°†å½“å‰ g ç½®ä¸ºæ­»äº¡çŠ¶æ€ï¼Œå‘èµ·æ–°ä¸€è½®è°ƒåº¦</p><h4 id="æŠ¢å è°ƒåº¦" tabindex="-1"><a class="header-anchor" href="#æŠ¢å è°ƒåº¦" aria-hidden="true">#</a> æŠ¢å è°ƒåº¦</h4><p>å‰ä¸‰ç§éƒ½æ˜¯ç”¨æˆ·æ€ï¼Œå¹¶ä¸”ç”± m ä¸‹çš„ g0 å®Œæˆï¼Œå”¯ç‹¬æŠ¢å è°ƒåº¦ä¸åŒã€‚</p><p>å…¸å‹åœºæ™¯ï¼Œæ¯”å¦‚<code>gé™·å…¥ç³»ç»Ÿè°ƒç”¨æ—¶é—´è¿‡é•¿</code>ï¼Œä¸”å…¨å±€çš„ p èµ„æºæ¯”è¾ƒç´§ç¼ºï¼Œåˆç”±äº<code>gå’Œmæ˜¯ç»‘å®šçš„ä¸èƒ½å˜</code>è¦ç»§ç»­æ‰§è¡Œï¼Œæ­¤æ—¶å°† <code>p å’Œ gï¼Œmè§£ç»‘</code>ï¼ŒæŠ¢å å‡ºæ¥ç”¨äºå…¶ä»– g çš„è°ƒåº¦ï¼Œç­‰ g å®Œæˆç³»ç»Ÿè°ƒç”¨åï¼Œä¼šé‡æ–°è¿›å…¥å¯æ‰§è¡Œé˜Ÿåˆ—ä¸­ç­‰å¾…è¢«è°ƒåº¦ã€‚</p><p>å› ä¸ºå‘èµ·ç³»ç»Ÿè°ƒç”¨æ—¶éœ€è¦æ‰“ç ´ç”¨æˆ·æ€çš„è¾¹ç•Œè¿›å…¥å†…æ ¸æ€ï¼Œæ­¤æ—¶ m ä¹Ÿä¼šå› ç³»ç»Ÿè°ƒç”¨è€Œé™·å…¥åƒµç›´ï¼Œæ— æ³•ä¸»åŠ¨å®ŒæˆæŠ¢å è°ƒåº¦çš„è¡Œä¸ºï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªå…¨å±€è§’è‰²ï¼Œä¹Ÿå°±æ˜¯å…¨å±€ç›‘æ§è€… gï¼Œè¿™ä¸ªå…¨å±€ç›‘æ§è€… g ä¼šè¶Šè¿‡ p ç›´æ¥ä¸ä¸€ä¸ª m è¿›è¡Œç»‘å®šï¼Œä¸æ–­è½®è¯¢å¯¹æ‰€æœ‰ p çš„æ‰§è¡ŒçŠ¶å†µè¿›è¡Œç›‘æ§. å€˜è‹¥å‘ç°æ»¡è¶³æŠ¢å è°ƒåº¦çš„æ¡ä»¶ï¼Œåˆ™ä¼šä»ç¬¬ä¸‰æ–¹çš„è§’åº¦å‡ºæ‰‹å¹²é¢„ï¼Œä¸»åŠ¨å‘èµ·è¯¥åŠ¨ä½œã€‚</p><h3 id="è°ƒåº¦æµç¨‹" tabindex="-1"><a class="header-anchor" href="#è°ƒåº¦æµç¨‹" aria-hidden="true">#</a> è°ƒåº¦æµç¨‹</h3><figure><img src="/assets/gmp-schedule-225d4d0b.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ol><li>ä»¥ g0 -&gt; g -&gt; g0 çš„ä¸€è½®å¾ªç¯ä¸ºä¾‹è¿›è¡Œä¸²è”</li><li>g0 æ‰§è¡Œ <code>schedule()</code> å‡½æ•°ï¼Œå¯»æ‰¾åˆ°ç”¨äºæ‰§è¡Œçš„ g</li><li>g0 æ‰§è¡Œ <code>execute()</code> æ–¹æ³•ï¼Œæ›´æ–°å½“å‰ gã€p çš„çŠ¶æ€ä¿¡æ¯ï¼Œå¹¶è°ƒç”¨ <code>gogo()</code> æ–¹æ³•ï¼Œå°†æ‰§è¡Œæƒäº¤ç»™ g</li><li>g å› ä¸»åŠ¨è®©æ¸¡( <code>gosche_m()</code> )ã€è¢«åŠ¨è°ƒåº¦( <code>park_m()</code> )ã€æ­£å¸¸ç»“æŸ( <code>goexit0()</code> )ç­‰åŸå› ï¼Œè°ƒç”¨ <code>m_call()</code> å‡½æ•°ï¼Œæ‰§è¡Œæƒé‡æ–°å›åˆ° g0 æ‰‹ä¸­</li><li>g0 æ‰§è¡Œ <code>schedule()</code> å‡½æ•°ï¼Œå¼€å¯æ–°ä¸€è½®å¾ªç¯</li></ol><h4 id="schedule" tabindex="-1"><a class="header-anchor" href="#schedule" aria-hidden="true">#</a> schedule</h4><p>è°ƒåº¦æµç¨‹çš„ä¸»å¹²æ–¹æ³•æ˜¯ä½äº runtime/proc.go ä¸­çš„ schedule å‡½æ•°ï¼Œæ­¤æ—¶çš„æ‰§è¡Œæƒä½äº g0 æ‰‹ä¸­</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// One round of scheduler: find a runnable goroutine and execute it.</span>
<span class="token comment">// Never returns.</span>
<span class="token keyword">func</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	_g_ <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>locks <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;schedule: holding locks&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>lockedg <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token function">stoplockedm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token function">execute</span><span class="token punctuation">(</span>_g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>lockedg<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment">// Never returns.</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// We should not schedule away from a g that is executing a cgo call,</span>
	<span class="token comment">// since the cgo call is using the m&#39;s g0 stack.</span>
	<span class="token keyword">if</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>incgo <span class="token punctuation">{</span>
		<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;schedule: in cgo&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

top<span class="token punctuation">:</span>
	pp <span class="token operator">:=</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	pp<span class="token punctuation">.</span>preempt <span class="token operator">=</span> <span class="token boolean">false</span>

	<span class="token keyword">if</span> sched<span class="token punctuation">.</span>gcwaiting <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token function">gcstopm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">goto</span> top
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> pp<span class="token punctuation">.</span>runSafePointFn <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token function">runSafePointFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Sanity check: if we are spinning, the run queue should be empty.</span>
	<span class="token comment">// Check this before calling checkTimers, as that might call</span>
	<span class="token comment">// goready to put a ready goroutine on the local run queue.</span>
	<span class="token keyword">if</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>spinning <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>pp<span class="token punctuation">.</span>runnext <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> pp<span class="token punctuation">.</span>runqhead <span class="token operator">!=</span> pp<span class="token punctuation">.</span>runqtail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;schedule: spinning with local work&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token function">checkTimers</span><span class="token punctuation">(</span>pp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

	<span class="token keyword">var</span> gp <span class="token operator">*</span>g
	<span class="token keyword">var</span> inheritTime <span class="token builtin">bool</span>

	<span class="token comment">// Normal goroutines will check for need to wakeP in ready,</span>
	<span class="token comment">// but GCworkers and tracereaders will not, so the check must</span>
	<span class="token comment">// be done here instead.</span>
	tryWakeP <span class="token operator">:=</span> <span class="token boolean">false</span>
	<span class="token keyword">if</span> trace<span class="token punctuation">.</span>enabled <span class="token operator">||</span> trace<span class="token punctuation">.</span>shutdown <span class="token punctuation">{</span>
		gp <span class="token operator">=</span> <span class="token function">traceReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> gp <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token function">casgstatus</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> _Gwaiting<span class="token punctuation">,</span> _Grunnable<span class="token punctuation">)</span>
			<span class="token function">traceGoUnpark</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
			tryWakeP <span class="token operator">=</span> <span class="token boolean">true</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> gp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> gcBlackenEnabled <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		gp <span class="token operator">=</span> gcController<span class="token punctuation">.</span><span class="token function">findRunnableGCWorker</span><span class="token punctuation">(</span>_g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> gp <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			tryWakeP <span class="token operator">=</span> <span class="token boolean">true</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> gp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token comment">// Check the global runnable queue once in a while to ensure fairness.</span>
		<span class="token comment">// Otherwise two goroutines can completely occupy the local runqueue</span>
		<span class="token comment">// by constantly respawning each other.</span>
		<span class="token keyword">if</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>schedtick<span class="token operator">%</span><span class="token number">61</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> sched<span class="token punctuation">.</span>runqsize <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			<span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
			gp <span class="token operator">=</span> <span class="token function">globrunqget</span><span class="token punctuation">(</span>_g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> gp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		gp<span class="token punctuation">,</span> inheritTime <span class="token operator">=</span> <span class="token function">runqget</span><span class="token punctuation">(</span>_g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token comment">// We can see gp != nil here even if the M is spinning,</span>
		<span class="token comment">// if checkTimers added a local goroutine via goready.</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> gp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		gp<span class="token punctuation">,</span> inheritTime <span class="token operator">=</span> <span class="token function">findrunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// blocks until work is available</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// This thread is going to run a goroutine and is not spinning anymore,</span>
	<span class="token comment">// so if it was marked as spinning we need to reset it now and potentially</span>
	<span class="token comment">// start a new spinning M.</span>
	<span class="token keyword">if</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>spinning <span class="token punctuation">{</span>
		<span class="token function">resetspinning</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> sched<span class="token punctuation">.</span>disable<span class="token punctuation">.</span>user <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">schedEnabled</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// Scheduling of this goroutine is disabled. Put it on</span>
		<span class="token comment">// the list of pending runnable goroutines for when we</span>
		<span class="token comment">// re-enable user scheduling and look again.</span>
		<span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token function">schedEnabled</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// Something re-enabled scheduling while we</span>
			<span class="token comment">// were acquiring the lock.</span>
			<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			sched<span class="token punctuation">.</span>disable<span class="token punctuation">.</span>runnable<span class="token punctuation">.</span><span class="token function">pushBack</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span>
			sched<span class="token punctuation">.</span>disable<span class="token punctuation">.</span>n<span class="token operator">++</span>
			<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
			<span class="token keyword">goto</span> top
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// If about to schedule a not-normal goroutine (a GCworker or tracereader),</span>
	<span class="token comment">// wake a P if there is one.</span>
	<span class="token keyword">if</span> tryWakeP <span class="token punctuation">{</span>
		<span class="token function">wakep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> gp<span class="token punctuation">.</span>lockedm <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token comment">// Hands off own p to the locked m,</span>
		<span class="token comment">// then blocks waiting for a new p.</span>
		<span class="token function">startlockedm</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span>
		<span class="token keyword">goto</span> top
	<span class="token punctuation">}</span>

	<span class="token function">execute</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> inheritTime<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li>å¯»æ‰¾åˆ°ä¸‹ä¸€ä¸ªæ‰§è¡Œçš„ goroutineï¼Œä½¿ç”¨ findRunnable</li><li>æ‰§è¡Œè¯¥ goroutineï¼Œä½¿ç”¨ execute</li></ol><h5 id="findrunnable" tabindex="-1"><a class="header-anchor" href="#findrunnable" aria-hidden="true">#</a> findRunnable</h5><p>è°ƒåº¦æµç¨‹ä¸­ï¼Œä¸€ä¸ªéå¸¸æ ¸å¿ƒçš„æ­¥éª¤ï¼Œå°±æ˜¯ä¸º m å¯»æ‰¾åˆ°ä¸‹ä¸€ä¸ªæ‰§è¡Œçš„ gï¼Œè¿™éƒ¨åˆ†å†…å®¹ä½äº runtime/proc.go çš„ findRunnable æ–¹æ³•ä¸­</p><figure><img src="/assets/gmp-findRunnable-9c338a70.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>todo æºç è§£è¯»</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h5 id="execute" tabindex="-1"><a class="header-anchor" href="#execute" aria-hidden="true">#</a> execute</h5><p>å½“ g0 ä¸º m å¯»æ‰¾åˆ°å¯æ‰§è¡Œçš„ g ä¹‹åï¼Œæ¥ä¸‹æ¥å°±å¼€å§‹æ‰§è¡Œ g. è¿™éƒ¨åˆ†å†…å®¹ä½äº runtime/proc.go çš„ execute æ–¹æ³•ä¸­</p><figure><img src="/assets/gmp-execute-188e9507.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>todo æºç è§£è¯»</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token comment">// Schedules gp to run on the current M.</span>
<span class="token comment">// If inheritTime is true, gp inherits the remaining time in the</span>
<span class="token comment">// current time slice. Otherwise, it starts a new time slice.</span>
<span class="token comment">// Never returns.</span>
<span class="token comment">//</span>
<span class="token comment">// Write barriers are allowed because this is called immediately after</span>
<span class="token comment">// acquiring a P in several places.</span>
<span class="token comment">//</span>
<span class="token comment">//go:yeswritebarrierrec</span>
<span class="token keyword">func</span> <span class="token function">execute</span><span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">,</span> inheritTime <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	_g_ <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// Assign gp.m before entering _Grunning so running Gs have an</span>
	<span class="token comment">// M.</span>
	_g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>curg <span class="token operator">=</span> gp
	gp<span class="token punctuation">.</span>m <span class="token operator">=</span> _g_<span class="token punctuation">.</span>m
	<span class="token function">casgstatus</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> _Grunnable<span class="token punctuation">,</span> _Grunning<span class="token punctuation">)</span>
	gp<span class="token punctuation">.</span>waitsince <span class="token operator">=</span> <span class="token number">0</span>
	gp<span class="token punctuation">.</span>preempt <span class="token operator">=</span> <span class="token boolean">false</span>
	gp<span class="token punctuation">.</span>stackguard0 <span class="token operator">=</span> gp<span class="token punctuation">.</span>stack<span class="token punctuation">.</span>lo <span class="token operator">+</span> _StackGuard
	<span class="token keyword">if</span> <span class="token operator">!</span>inheritTime <span class="token punctuation">{</span>
		_g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>schedtick<span class="token operator">++</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Check whether the profiler needs to be turned on or off.</span>
	hz <span class="token operator">:=</span> sched<span class="token punctuation">.</span>profilehz
	<span class="token keyword">if</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>profilehz <span class="token operator">!=</span> hz <span class="token punctuation">{</span>
		<span class="token function">setThreadCPUProfiler</span><span class="token punctuation">(</span>hz<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> trace<span class="token punctuation">.</span>enabled <span class="token punctuation">{</span>
		<span class="token comment">// GoSysExit has to happen when we have a P, but before GoStart.</span>
		<span class="token comment">// So we emit it here.</span>
		<span class="token keyword">if</span> gp<span class="token punctuation">.</span>syscallsp <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> gp<span class="token punctuation">.</span>sysblocktraced <span class="token punctuation">{</span>
			<span class="token function">traceGoSysExit</span><span class="token punctuation">(</span>gp<span class="token punctuation">.</span>sysexitticks<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token function">traceGoStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token function">gogo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gp<span class="token punctuation">.</span>sched<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ‡æ¢ g çš„çŠ¶æ€ä» runnable åˆ° runningï¼Œæœ€ç»ˆæ‰§è¡Œ<code>gogo()</code></p><h5 id="gosched-m" tabindex="-1"><a class="header-anchor" href="#gosched-m" aria-hidden="true">#</a> gosched_m</h5><p>Gosched()æ–¹æ³•å†…éƒ¨è°ƒç”¨ mcall(gosched_m)</p><p>todo æºç è§£è¯»</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h5 id="park-m" tabindex="-1"><a class="header-anchor" href="#park-m" aria-hidden="true">#</a> park_m</h5><p>gopark()æ–¹æ³•å†…éƒ¨è°ƒç”¨ mcall(park_m)</p><p>todo æºç è§£è¯»</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h5 id="goready" tabindex="-1"><a class="header-anchor" href="#goready" aria-hidden="true">#</a> goready</h5><p>goready()</p><p>todo æºç è§£è¯»</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h5 id="goexit0" tabindex="-1"><a class="header-anchor" href="#goexit0" aria-hidden="true">#</a> goexit0</h5><p>goexit1()å†…éƒ¨è°ƒç”¨ mcall(goexit0)</p><p>todo æºç è§£è¯»</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h5 id="retake" tabindex="-1"><a class="header-anchor" href="#retake" aria-hidden="true">#</a> retake</h5><p>todo æºç è§£è¯»</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h5 id="reentersyscall" tabindex="-1"><a class="header-anchor" href="#reentersyscall" aria-hidden="true">#</a> reentersyscall</h5><p>todo æºç è§£è¯»</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h5 id="exitsyscall" tabindex="-1"><a class="header-anchor" href="#exitsyscall" aria-hidden="true">#</a> exitsyscall</h5><p>todo æºç è§£è¯»</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="reference" tabindex="-1"><a class="header-anchor" href="#reference" aria-hidden="true">#</a> reference</h2><p><a href="https://mp.weixin.qq.com/s/jIWe3nMP6yiuXeBQgmePDg" target="_blank" rel="noopener noreferrer">https://mp.weixin.qq.com/s/jIWe3nMP6yiuXeBQgmePDg<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/xyz3282836/monodoc/edit/master/packages/note/src/go/gpm.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page on GitHub" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->Edit this page on GitHub<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: liuruizhou@bilibili.com">liuruizhou</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="md-link nav-link prev" href="/go/gc%20%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.html"><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->gc æ€§èƒ½ä¼˜åŒ–</div></a><a class="md-link nav-link next" href="/go/go%20tool%20compile.html"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow end"></span></div><div class="link">go tool compile<!----></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">é»˜è®¤é¡µè„š</div><div class="vp-copyright">Copyright Â© 2023 rz</div></footer></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-08e26ff4.js" defer></script>
  </body>
</html>
